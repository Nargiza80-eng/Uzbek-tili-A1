<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dono Bola! (4‚Äì6)</title>

  <style>
    :root{
      --ink:#0f172a;
      --muted:#475569;
      --line:rgba(15,23,42,.12);
      --shadow:0 14px 30px rgba(2,6,23,.12);
      --radius:22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      padding:16px;
      min-height:100vh;
      overflow-x:hidden;

      background:
        linear-gradient(180deg, rgba(223,247,240,.92), rgba(234,246,255,.92)),
        url("data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27720%27%20height%3D%27720%27%20viewBox%3D%270%200%20720%20720%27%3E%3Crect%20width%3D%27720%27%20height%3D%27720%27%20fill%3D%27%23f7fbff%27/%3E%3Cg%20opacity%3D%270.22%27%3E%3Cg%20transform%3D%27translate(40%2C40)%27%3E%3Cpath%20d%3D%27M120%200%20L160%2040%20L120%2080%20L80%2040%20Z%27%20fill%3D%27%230ea5a4%27/%3E%3Cpath%20d%3D%27M120%20110%20L170%20160%20L120%20210%20L70%20160%20Z%27%20fill%3D%27%2322c55e%27/%3E%3Cpath%20d%3D%27M120%20240%20L160%20280%20L120%20320%20L80%20280%20Z%27%20fill%3D%27%23f59e0b%27/%3E%3Cpath%20d%3D%27M0%20120%20L40%20160%20L0%20200%20L-40%20160%20Z%27%20fill%3D%27%2314b8a6%27/%3E%3Cpath%20d%3D%27M240%20120%20L280%20160%20L240%20200%20L200%20160%20Z%27%20fill%3D%27%2310b981%27/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      background-size: cover, 720px 720px;
      background-attachment: fixed, fixed;
    }

    .app{max-width:900px;margin:0 auto}
    .top{
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(6px);
      position:relative;
      overflow:hidden;
    }

    /* Header */
    .hero{
      display:flex; gap:14px; align-items:flex-start;
      flex-wrap:wrap; justify-content:space-between;
    }
    .heroLeft{display:flex; gap:14px; align-items:center; flex-wrap:wrap}

    .sunWrap{width:104px;height:104px;flex:0 0 auto}
    .sun{
      width:104px;height:104px;border-radius:999px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 30%, #fff6cc, #fbbf24 55%, #f59e0b 100%);
      box-shadow: 0 12px 28px rgba(245,158,11,.36);
      border: 5px solid rgba(255,255,255,.72);
    }
    .sunPct{font-weight:1000;font-size:22px;color:#7c2d12;text-shadow: 0 2px 0 rgba(255,255,255,.35)}

    h1{margin:0;font-size:24px;font-weight:1000;letter-spacing:.2px}

    .helloBig{
      margin-top:6px; font-weight:1000;
      font-size:40px; line-height:1.05;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .helloBig .name{color:#065f46;text-shadow:0 2px 0 rgba(255,255,255,.45)}

    .topActions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; position:relative}
    .langBtn,.profileBtn{
      border-radius:18px;
      font-weight:1000;
      border:1px solid rgba(15,23,42,.14);
      cursor:pointer;
      user-select:none;
      padding:12px 14px;
      background: rgba(255,255,255,.94);
      font-size:16px;
      white-space:nowrap;
    }
    .profileBtn{display:flex; align-items:center; gap:10px}
    .profileMenu{
      position:absolute;
      right:0; top:52px;
      width:240px;
      background: rgba(255,255,255,.97);
      border:1px solid rgba(15,23,42,.12);
      border-radius:18px;
      box-shadow: 0 18px 36px rgba(2,6,23,.16);
      padding:8px;
      display:none;
      z-index:50;
    }
    .profileMenu.show{display:block}
    .menuItem{
      width:100%;
      text-align:left;
      border-radius:14px;
      padding:12px;
      border:1px solid transparent;
      background:transparent;
      font-weight:900;
      cursor:pointer;
      font-size:16px;
    }
    .menuItem:hover{background: rgba(15,23,42,.06)}

    /* Progress */
    .barWrap{
      margin-top:12px;
      background:rgba(255,255,255,.96);
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow: 0 12px 28px rgba(2,6,23,.07);
    }
    .barRow{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
    .barLabel{font-weight:1000;font-size:18px}
    .barText{color:var(--muted);font-weight:1000;font-size:16px}
    .bar{margin-top:12px;height:18px;background: rgba(15,23,42,.10);border-radius:999px;overflow:hidden;border:1px solid rgba(15,23,42,.10)}
    .fill{height:100%;width:0%;background: linear-gradient(90deg, #22c55e, #16a34a);border-radius:999px;transition: width .45s ease}

    .achRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .achIcon{
      width:46px;height:46px;border-radius:999px;
      display:grid;place-items:center;font-size:24px;
      background: rgba(34,197,94,.18);
      border:2px solid rgba(34,197,94,.35);
      box-shadow: 0 14px 28px rgba(2,6,23,.10);
    }

    /* Grid + visible path */
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
      position:relative;
      padding-left:30px;
    }
    .grid::before{
      content:"";
      position:absolute;
      left:12px;
      top:10px;
      bottom:10px;
      width:12px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(34,197,94,.55), rgba(59,130,246,.45), rgba(245,158,11,.45));
      border:2px solid rgba(15,23,42,.10);
      box-shadow: 0 18px 40px rgba(2,6,23,.12);
    }

    /* ‚úÖ MOBILE-SAFE TILE (no overlap) */
    .tile{
      border:2px solid rgba(15,23,42,.10);
      border-radius:28px;
      box-shadow: 0 18px 38px rgba(2,6,23,.14);
      text-decoration:none;
      color:inherit;
      position:relative;
      overflow:hidden;
      cursor:pointer;
      touch-action:manipulation;

      display:grid;
      grid-template-columns: 120px 1fr;
      grid-template-areas:
        "icon tag"
        "icon title"
        "icon under";
      gap:14px;
      padding:16px;
      align-items:center;

      background: rgba(255,255,255,.97);
      min-height:150px;
    }
    .tile:active{transform: translateY(1px)}

    .stepDot{
      position:absolute;
      left:-28px;
      top:50%;
      transform: translateY(-50%);
      width:38px;height:38px;border-radius:999px;
      background: rgba(255,255,255,.98);
      border:3px solid rgba(15,23,42,.22);
      box-shadow: 0 16px 34px rgba(2,6,23,.12);
    }
    .tile.done .stepDot{border-color: rgba(34,197,94,.70); background: rgba(34,197,94,.25);}
    .tile.current .stepDot{border-color: rgba(245,158,11,.80); background: rgba(245,158,11,.25);}

    .icon{
      grid-area:icon;
      width:120px;height:120px;border-radius:28px;
      display:grid;place-items:center;
      font-size:70px;
      border:2px solid rgba(15,23,42,.10);
      box-shadow: 0 18px 44px rgba(2,6,23,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.58));
      z-index:2;
    }

    .tagRight{
      grid-area:tag;
      justify-self:end;
      align-self:start;
      font-size:22px;
      font-weight:1100;
      padding:12px 16px;
      border-radius:999px;
      border:2px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      color: rgba(15,23,42,.90);
      letter-spacing:1px;
      text-transform: uppercase;
      z-index:3;
    }
    .tagRight.open{
      border-color: rgba(34,197,94,.40);
      background: rgba(34,197,94,.18);
      color:#065f46;
    }
    .tagRight.lock{
      border-color: rgba(15,23,42,.14);
      background: rgba(15,23,42,.06);
      color: rgba(15,23,42,.75);
    }

    .title{
      grid-area:title;
      font-size:32px;
      font-weight:1000;
      line-height:1.05;
      letter-spacing:.2px;
      min-width:0;
      word-break:break-word;
      z-index:2;
    }

    .underTag{
      grid-area:under;
      justify-self:end;
      align-self:end;
      font-size:14px;
      font-weight:1000;
      color: rgba(15,23,42,.80);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(15,23,42,.10);
      z-index:3;
    }

    /* Same-color soft strip under each tile */
    .tile::after{
      content:"";
      position:absolute;
      left:16px;
      right:16px;
      bottom:10px;
      height:16px;
      border-radius:999px;
      background: var(--soft, rgba(0,0,0,.06));
      border:1px solid rgba(15,23,42,.06);
      z-index:1;
      opacity:.95;
    }

    .tile.locked{opacity:.78; filter: grayscale(.16);}

    /* Bottom buttons */
    .btnRow{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
    .btnWide{
      flex:1;min-width:240px;
      text-align:center;
      padding:16px;
      border-radius:20px;
      font-weight:1000;
      border:1px solid transparent;
      cursor:pointer;
      user-select:none;
      font-size:18px;
    }
    .btnWide.primary{
      background: linear-gradient(180deg, #34d399, #22c55e);
      color:#052e1b;
      border-color: rgba(5,46,27,.10);
      box-shadow: 0 18px 40px rgba(34,197,94,.22);
    }
    .btnWide.secondary{
      background: rgba(255,255,255,.96);
      color: var(--ink);
      border-color: var(--line);
    }

    /* Gates */
    .gate{
      position:fixed;
      inset:0;
      z-index:10000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:
        radial-gradient(circle at 25% 15%, rgba(255,255,255,.18), transparent 35%),
        radial-gradient(circle at 80% 25%, rgba(255,255,255,.14), transparent 40%),
        rgba(2,6,23,.55);
      backdrop-filter: blur(10px) saturate(1.1);
    }
    .gate.show{display:flex}
    .gateCard{
      width:min(520px, 92vw);
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.35);
      border-radius:26px;
      box-shadow: 0 22px 70px rgba(2,6,23,.35);
      padding:16px;
      text-align:center;
    }
    .gateTitle{font-size:24px;font-weight:1000;margin:6px 0 6px}
    .gateText{margin:0 0 12px;color: rgba(15,23,42,.78);font-weight:900;}

    .nameInput{
      width:min(360px, 86vw);
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.18);
      font-weight:1000;
      font-size:18px;
      outline:none;
      background: rgba(255,255,255,.95);
    }

    .gateBtn{
      width:min(360px, 86vw);
      margin-top:10px;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(5,46,27,.10);
      background: linear-gradient(180deg, #34d399, #22c55e);
      color:#052e1b;
      font-weight:1000;
      cursor:pointer;
      font-size:18px;
    }
    .btnGhost{
      width:min(360px, 86vw);
      margin-top:10px;
      padding:14px;
      border-radius:18px;
      border:1px dashed rgba(15,23,42,.22);
      background: rgba(255,255,255,.92);
      color: rgba(15,23,42,.88);
      font-weight:1000;
      cursor:pointer;
      font-size:16px;
    }
    .gateHint{margin-top:10px;font-size:12.5px;font-weight:900;color: rgba(15,23,42,.62);}

    /* ‚úÖ Responsive: phone */
    @media (max-width: 420px){
      .sunWrap{width:78px;height:78px}
      .sun{width:78px;height:78px}
      .sunPct{font-size:18px}

      h1{font-size:20px}
      .helloBig{font-size:30px}

      .grid{padding-left:22px}
      .grid::before{left:8px;width:10px}
      .stepDot{left:-22px;width:30px;height:30px}

      .tile{
        grid-template-columns: 96px 1fr;
        gap:12px;
        min-height:120px;
      }
      .icon{width:96px;height:96px;font-size:52px;border-radius:22px}
      .title{font-size:24px}
      .tagRight{font-size:16px;padding:10px 12px}
      .underTag{font-size:12px;padding:6px 10px}
    }

    /* ‚úÖ Responsive: tablet */
    @media (min-width: 700px){
      .tile{grid-template-columns: 140px 1fr; min-height:170px}
      .icon{width:140px;height:140px;font-size:82px}
      .title{font-size:38px}
      .tagRight{font-size:24px}
    }

    /* ‚úÖ Responsive: desktop */
    @media (min-width: 980px){
      .app{max-width:980px}
      .top{padding:18px}
      .tile{grid-template-columns: 160px 1fr; min-height:180px}
      .icon{width:160px;height:160px;font-size:90px}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">

      <div class="hero">
        <div class="heroLeft">
          <div class="sunWrap" aria-hidden="true">
            <div class="sun"><div class="sunPct" id="mainPct">0%</div></div>
          </div>

          <div>
            <h1>üåø Dono Bola!</h1>
            <div class="helloBig">
              <span>ü¶Å</span>
              <span id="helloWord">Hello,</span>
              <span class="name" id="childNameBig">Friend!</span>
              <span>‚ú®</span>
            </div>
          </div>
        </div>

        <div class="topActions">
          <button class="langBtn" id="langBtn" type="button">UZ</button>

          <button class="profileBtn" id="profileBtn" type="button" aria-haspopup="menu" aria-expanded="false">
            üßí <span id="profileName">Friend</span> ‚ñæ
          </button>

          <div class="profileMenu" id="profileMenu" role="menu">
            <button class="menuItem" id="changeNameBtn" type="button">‚úèÔ∏è Change name</button>
          </div>
        </div>
      </div>

      <!-- Progress -->
      <div class="barWrap">
        <div class="barRow">
          <div class="barLabel" id="progressLabel">‚≠ê Progress</div>
          <div class="barText" id="progressText">0 / 93</div>
          <div class="achRow" id="achRow"></div>
        </div>
        <div class="bar">
          <div class="fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Lessons -->
      <div class="grid" id="lessonGrid"></div>

      <div class="btnRow">
        <button class="btnWide primary" id="premiumBtn" type="button">üîì Premium</button>
        <button class="btnWide secondary" id="resetBtn" type="button">‚ôªÔ∏è Reset</button>
      </div>

    </div>
  </div>

  <!-- Name Gate -->
  <div class="gate" id="nameGate">
    <div class="gateCard" role="dialog" aria-modal="true">
      <div style="font-size:44px; line-height:1;">üßí‚ú®</div>
      <div class="gateTitle" id="nameGateTitle">What‚Äôs your name?</div>
      <p class="gateText" id="nameGateText">Type your name ‚úçÔ∏è</p>
      <input class="nameInput" id="nameInput" type="text" autocomplete="name"
             placeholder="Example: Ali" maxlength="18" />
      <button class="gateBtn" id="startBtn" type="button">Start üöÄ</button>
      <div class="gateHint" id="nameGateHint">Tip: 2 letters is enough üôÇ</div>
    </div>
  </div>

  <!-- Paywall Gate -->
  <div class="gate" id="paywallGate">
    <div class="gateCard" role="dialog" aria-modal="true">
      <div style="font-size:44px; line-height:1;">üîì‚ú®</div>
      <div class="gateTitle" id="paywallTitle">Premium</div>
      <p class="gateText" id="paywallText">Unlock all lessons üîì</p>

      <button class="gateBtn" id="buyBtn" type="button">Buy Premium ‚Äî $9.99</button>
      <button class="btnGhost" id="closePaywallBtn" type="button">Close</button>

      <div class="gateHint" id="paywallHint">GitHub demo now. Real payment later in the app stores.</div>
    </div>
  </div>

<script>
  const PREMIUM_KEY = "premium_unlocked";
  const CHILD_KEY   = "childName";
  const LANG_KEY    = "ui_lang";
  const PRICE_LABEL = "$9.99";

  const UI = {
    en: {
      langBtn: "UZ",
      helloWord: "Hello,",
      friendFallback: "Friend!",
      changeName: "‚úèÔ∏è Change name",
      progressLabel: "‚≠ê Progress",
      openLabel: "OPEN",
      freeLabel: "FREE",
      lessonLabel: (id)=> `Lesson ${id}`,
      paywallTitle: "Premium",
      paywallText: (id)=> `Premium is required for Lesson ${id}.`,
      buyBtn: (price)=> `Buy Premium ‚Äî ${price}`,
      close: "Close",
      hint: "GitHub demo now. Real payment later in the app stores.",
      nameGateTitle: "What‚Äôs your name?",
      nameGateText: "Type your name ‚úçÔ∏è",
      namePlaceholder: "Example: Ali",
      startBtn: "Start üöÄ",
      nameGateHint: "Tip: 2 letters is enough üôÇ",
      resetConfirm: "Start over? (Progress will be cleared)",
      premiumActivated: "‚úÖ Premium activated (demo)!"
    },
    uz: {
      langBtn: "ENG",
      helloWord: "Salom,",
      friendFallback: "Do‚Äòst!",
      changeName: "‚úèÔ∏è Ismni o‚Äòzgartirish",
      progressLabel: "‚≠ê Yutuq",
      openLabel: "OCHMOQ",
      freeLabel: "BEPUL",
      lessonLabel: (id)=> `${id}-dars`,
      paywallTitle: "Premium",
      paywallText: (id)=> `${id}-dars uchun Premium kerak üîí`,
      buyBtn: (price)=> `Premium sotib olish ‚Äî ${price}`,
      close: "Yopish",
      hint: "Hozir GitHub demo. Keyin haqiqiy to‚Äòlov bo‚Äòladi.",
      nameGateTitle: "Isming nima?",
      nameGateText: "Ismingni yoz ‚úçÔ∏è",
      namePlaceholder: "Masalan: Ali",
      startBtn: "Boshlaymiz! üöÄ",
      nameGateHint: "Maslahat: 2 ta harf yetadi üôÇ",
      resetConfirm: "Hammasini qaytadan boshlaymizmi? (Natija o‚Äòchadi)",
      premiumActivated: "‚úÖ Premium (demo) aktiv!"
    }
  };

  function getLang(){
    const v = localStorage.getItem(LANG_KEY);
    return (v === "uz" || v === "en") ? v : "en";
  }
  function setLang(v){ localStorage.setItem(LANG_KEY, v); }
  function T(){ return UI[getLang()]; }

  // completion rule for progress icons
  const MIN_WORDS_PER_LESSON = { 1:5,2:5,3:5,4:5,5:5,6:5,7:5,8:5,9:5,10:5 };

  function getLearnedSet(){
    try { return new Set(JSON.parse(localStorage.getItem("learned") || "[]")); }
    catch { return new Set(); }
  }

  const LESSONS = [
    { id: 1, file:"lesson1.html", icon:"üëã", en:"Greetings",     uz:"Salomlashuv", free:true  },
    { id: 2, file:"lesson2.html", icon:"üî¢", en:"Numbers",       uz:"Sonlar",      free:false },
    { id: 3, file:"lesson3.html", icon:"üêæ", en:"Animals",       uz:"Hayvonlar",   free:false },
    { id: 4, file:"lesson4.html", icon:"üé®", en:"Colors",        uz:"Ranglar",     free:false },
    { id: 5, file:"lesson5.html", icon:"üçé", en:"Fruits",        uz:"Mevalar",     free:false },
    { id: 6, file:"lesson6.html", icon:"ü•ï", en:"Vegetables",    uz:"Sabzavot",    free:false },
    { id: 7, file:"lesson7.html", icon:"üè†", en:"Home",          uz:"Uy",          free:false },
    { id: 8, file:"lesson8.html", icon:"üëï", en:"Clothes",       uz:"Kiyim",       free:false },
    { id: 9, file:"lesson9.html", icon:"üöó", en:"Transport",     uz:"Transport",   free:false },
    { id:10, file:"lesson10.html",icon:"üåô", en:"Daily routine", uz:"Kun tartibi", free:false }
  ];

  // Stronger pastels + soft bar (same color)
  const COLORS = [
    { bg:"rgba(251, 113, 133, .42)", soft:"rgba(251, 113, 133, .18)" },
    { bg:"rgba(251, 146,  60, .45)", soft:"rgba(251, 146,  60, .18)" },
    { bg:"rgba(250, 204,  21, .45)", soft:"rgba(250, 204,  21, .18)" },
    { bg:"rgba( 34, 197,  94, .38)", soft:"rgba( 34, 197,  94, .16)" },
    { bg:"rgba( 20, 184, 166, .40)", soft:"rgba( 20, 184, 166, .16)" },
    { bg:"rgba( 59, 130, 246, .40)", soft:"rgba( 59, 130, 246, .16)" },
    { bg:"rgba( 99, 102, 241, .42)", soft:"rgba( 99, 102, 241, .16)" },
    { bg:"rgba(168,  85, 247, .40)", soft:"rgba(168,  85, 247, .16)" },
    { bg:"rgba(236,  72, 153, .38)", soft:"rgba(236,  72, 153, .16)" },
    { bg:"rgba(100, 116, 139, .34)", soft:"rgba(100, 116, 139, .14)" }
  ];

  const TOTAL_WORDS = 93;

  function isPremium(){ return localStorage.getItem(PREMIUM_KEY) === "true"; }
  function setPremium(v){ localStorage.setItem(PREMIUM_KEY, v ? "true" : "false"); }

  function normalizeName(s){ return (s || "").trim().replace(/\s+/g, " ").slice(0, 18); }

  function lessonLearnedCount(learnedSet, lessonId){
    let c = 0;
    const prefix = "L" + lessonId + "_";
    for (const key of learnedSet){
      if (key.startsWith(prefix)) c++;
    }
    return c;
  }
  function isLessonCompleted(learnedSet, lessonId){
    const need = MIN_WORDS_PER_LESSON[lessonId] ?? 1;
    return lessonLearnedCount(learnedSet, lessonId) >= need;
  }

  // Only lesson 1 is open without premium
  function canOpenLesson(lessonId){
    if(lessonId === 1) return true;
    return isPremium();
  }

  function openPaywall(lessonId){
    const tt = T();
    const gate = document.getElementById("paywallGate");
    const text = document.getElementById("paywallText");
    const buy  = document.getElementById("buyBtn");

    if(String(lessonId).toLowerCase() === "premium"){
      text.innerText = (getLang()==="uz") ? "Barcha darslar ochiladi üîì" : "Unlock all lessons üîì";
    } else {
      text.innerText = tt.paywallText(lessonId);
    }

    buy.innerText = tt.buyBtn(PRICE_LABEL);
    buy.dataset.lessonId = String(lessonId);
    gate.classList.add("show");
  }
  function closePaywall(){ document.getElementById("paywallGate").classList.remove("show"); }

  function applyTexts(){
    const tt = T();
    document.getElementById("langBtn").innerText = tt.langBtn;
    document.getElementById("helloWord").innerText = tt.helloWord;
    document.getElementById("changeNameBtn").innerText = tt.changeName;
    document.getElementById("progressLabel").innerText = tt.progressLabel;

    document.getElementById("nameGateTitle").innerText = tt.nameGateTitle;
    document.getElementById("nameGateText").innerText  = tt.nameGateText;
    document.getElementById("nameInput").placeholder   = tt.namePlaceholder;
    document.getElementById("startBtn").innerText      = tt.startBtn;
    document.getElementById("nameGateHint").innerText  = tt.nameGateHint;

    document.getElementById("paywallTitle").innerText = tt.paywallTitle;
    document.getElementById("buyBtn").innerText       = tt.buyBtn(PRICE_LABEL);
    document.getElementById("closePaywallBtn").innerText = tt.close;
    document.getElementById("paywallHint").innerText  = tt.hint;
  }

  function applyGreeting(){
    const tt = T();
    const name = localStorage.getItem(CHILD_KEY) || "";
    const child = name ? name : tt.friendFallback;

    document.getElementById("childNameBig").innerText = child;
    document.getElementById("profileName").innerText  = child.replace("!", "");
  }

  function showNameGate(){
    const gate = document.getElementById("nameGate");
    gate.classList.add("show");
    const input = document.getElementById("nameInput");
    const btn = document.getElementById("startBtn");

    btn.disabled = true;
    input.value = "";
    setTimeout(() => input.focus(), 50);

    const validate = () => { btn.disabled = normalizeName(input.value).length < 2; };
    input.oninput = validate;
    input.onkeydown = (e)=>{ if(e.key==="Enter" && !btn.disabled) btn.click(); };

    btn.onclick = () => {
      const nm = normalizeName(input.value);
      if(nm.length < 2) return;
      localStorage.setItem(CHILD_KEY, nm);
      gate.classList.remove("show");
      applyGreeting();
    };
  }

  function renderProgressIcons(){
    const learned = getLearnedSet();
    const row = document.getElementById("achRow");
    row.innerHTML = "";
    LESSONS.forEach(L=>{
      if(isLessonCompleted(learned, L.id)){
        const d = document.createElement("div");
        d.className = "achIcon";
        d.title = `Lesson ${L.id}`;
        d.textContent = L.icon;
        row.appendChild(d);
      }
    });
  }

  function renderLessons(){
    const tt = T();
    const learned = getLearnedSet();

    const learnedCount = learned.size;
    const pct = Math.max(0, Math.min(100, Math.round((learnedCount / TOTAL_WORDS) * 100)));
    document.getElementById("mainPct").innerText = pct + "%";
    document.getElementById("progressText").innerText = `${learnedCount} / ${TOTAL_WORDS}`;
    document.getElementById("progressFill").style.width = pct + "%";

    const grid = document.getElementById("lessonGrid");
    grid.innerHTML = "";

    let current = 1;
    for(let i=1;i<=LESSONS.length;i++){
      if(!isLessonCompleted(learned, i)){ current = i; break; }
    }

    LESSONS.forEach((L, idx)=>{
      const open = canOpenLesson(L.id);
      const done = isLessonCompleted(learned, L.id);
      const isCurrent = (L.id === current);

      const c = COLORS[idx % COLORS.length];

      const a = document.createElement("a");
      a.className = "tile" + (open ? "" : " locked") + (done ? " done" : "") + (isCurrent ? " current" : "");
      a.href = open ? L.file : "#";
      a.style.background = `linear-gradient(180deg, ${c.bg}, rgba(255,255,255,.92))`;
      a.style.setProperty("--soft", c.soft);

      const dot = document.createElement("div");
      dot.className = "stepDot";
      a.appendChild(dot);

      const ic = document.createElement("div");
      ic.className = "icon";
      ic.textContent = L.icon;
      a.appendChild(ic);

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = (getLang()==="uz") ? L.uz : L.en;
      a.appendChild(title);

      const tag = document.createElement("div");
      tag.className = "tagRight " + (open ? "open" : "lock");
      tag.textContent = (L.id === 1 && !isPremium()) ? tt.freeLabel : tt.openLabel;
      a.appendChild(tag);

      const under = document.createElement("div");
      under.className = "underTag";
      under.textContent = tt.lessonLabel(L.id);
      a.appendChild(under);

      a.addEventListener("click", (e)=>{
        if(!open){
          e.preventDefault();
          openPaywall(L.id);
        }
      });

      grid.appendChild(a);
    });
  }

  function updateAll(){
    applyTexts();
    applyGreeting();
    renderProgressIcons();
    renderLessons();
  }

  function wireUI(){
    // language
    document.getElementById("langBtn").addEventListener("click", ()=>{
      const next = (getLang()==="en") ? "uz" : "en";
      setLang(next);
      updateAll();
    });

    // profile
    const profileBtn = document.getElementById("profileBtn");
    const profileMenu = document.getElementById("profileMenu");

    profileBtn.addEventListener("click", ()=>{
      const isOpen = profileMenu.classList.toggle("show");
      profileBtn.setAttribute("aria-expanded", String(isOpen));
    });

    document.addEventListener("click", (e)=>{
      const inside = profileMenu.contains(e.target) || profileBtn.contains(e.target);
      if(!inside){
        profileMenu.classList.remove("show");
        profileBtn.setAttribute("aria-expanded","false");
      }
    });

    document.getElementById("changeNameBtn").addEventListener("click", ()=>{
      profileMenu.classList.remove("show");
      localStorage.removeItem(CHILD_KEY);
      showNameGate();
    });

    document.getElementById("premiumBtn").addEventListener("click", ()=> openPaywall("Premium"));

    document.getElementById("buyBtn").addEventListener("click", ()=>{
      setPremium(true); // demo unlock
      closePaywall();
      updateAll();
      alert(T().premiumActivated);
    });

    document.getElementById("closePaywallBtn").addEventListener("click", ()=> closePaywall());
    document.getElementById("paywallGate").addEventListener("click", (e)=>{
      if(e.target.id === "paywallGate") closePaywall();
    });

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      const ok = confirm(T().resetConfirm);
      if(!ok) return;
      localStorage.removeItem("learned");
      localStorage.removeItem(PREMIUM_KEY);
      updateAll();
    });

    window.addEventListener("focus", updateAll);
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) updateAll(); });
    window.addEventListener("pageshow", updateAll);
  }

  window.addEventListener("load", ()=>{
    wireUI();
    if(!localStorage.getItem(LANG_KEY)) setLang("en");
    if(!localStorage.getItem(CHILD_KEY)) showNameGate();
    updateAll();
  });
</script>
</body>
</html>
