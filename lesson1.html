<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1-dars ‚Äì Salomlashuv (Kids)</title>

  <style>
    :root{
      --bg:#F7F3EE;
      --card:#FFFFFF;
      --ink:#1F2937;
      --muted:#6B7280;
      --line:#E7E0D8;
      --accent:#6FA8A1;
      --accent2:#F2C98A;
      --good:#16a34a;
      --bad:#dc2626;
      --shadow:0 10px 26px rgba(31,41,55,0.10);
      --radius:18px;
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      padding: 18px;
    }

    .app{max-width:980px;margin:0 auto;}
    .top{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      position: relative;
      overflow:hidden;
    }

    .headRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }

    h1{margin:0;font-size:22px;}
    .sub{margin-top:6px;color:var(--muted);font-weight:800}

    /* Language switch */
    .langSwitch{
      display:flex;
      gap:6px;
      background:#F1FBF9;
      border:1px solid #D7F1ED;
      padding:6px;
      border-radius:999px;
      user-select:none;
    }
    .langBtn{
      border:none;
      background:transparent;
      padding:6px 12px;
      border-radius:999px;
      font-weight:1000;
      cursor:pointer;
      color:#1B4D48;
    }
    .langBtn.active{
      background:var(--accent);
      color:#fff;
    }

    /* Progress + blocks */
    .bar{
      margin-top:12px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      box-shadow: var(--shadow);
    }
    .barRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .track{
      height:12px;
      background:#F3F4F6;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #E5E7EB;
      margin-top:10px;
    }
    .fill{height:100%;width:0%;background:var(--accent);transition:width .25s ease;}

    /* Cards */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:12px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      text-align:center;
      position:relative;
    }

    .emoji{font-size:50px; line-height:1;}
    .uz{font-size:30px;font-weight:1000;margin-top:8px}
    .en{font-size:18px;font-weight:1000;margin-top:8px;display:none}
    .pr{color:var(--muted);font-style:italic;margin-top:6px;font-size:13px}

    .audioBtn{
      width:100%;
      margin-top:10px;
      padding:12px;
      font-size:15px;
      border:none;
      border-radius:14px;
      background:var(--accent2);
      color:#3b2a10;
      font-weight:1000;
      cursor:pointer;
    }

    .stars{
      margin-top:8px;
      font-size:18px;
      color:#F59E0B;
      font-weight:1000;
    }

    /* Quiz */
    .quizWrap{
      margin-top:12px;
      background:#F9FAFB;
      border:1px dashed #E5E7EB;
      border-radius:14px;
      padding:12px;
      text-align:left;
    }
    .qTitle{
      font-weight:1000;
      margin:0 0 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .qText{margin:0 0 10px;color:var(--muted);font-weight:900}
    .opts{display:grid;gap:8px;}
    .opt{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:1000;
      cursor:pointer;
      text-align:left;
    }
    .opt[disabled]{opacity:.6; cursor:not-allowed;}
    .result{
      margin-top:10px;
      font-weight:1000;
      display:none;
      padding:10px;
      border-radius:14px;
      border:1px solid transparent;
    }
    .result.good{display:block;color:var(--good);background:#ECFDF5;border-color:#BBF7D0;}
    .result.bad{display:block;color:var(--bad);background:#FEF2F2;border-color:#FECACA;}

    /* Navigation */
    .navRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    a.nav,a.next{
      flex:1;
      min-width:200px;
      text-align:center;
      text-decoration:none;
      padding:12px;
      border-radius:14px;
      font-weight:1000;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    a.nav{background:#fff;border:1px solid var(--line);color:var(--ink);}
    a.next{background:var(--accent);color:#fff;}

    /* Celebration overlay */
    .celebrate{
      position:absolute;
      inset:0;
      background:rgba(247,243,238,0.90);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:20;
    }
    .celebrate.show{display:flex;}
    .celebrateCard{
      max-width:560px;
      width:100%;
      background:#fff;
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow: var(--shadow);
      padding:18px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .big{font-size:44px; font-weight:1000; margin:6px 0;}
    .small{color:var(--muted); font-weight:900; margin:0 0 12px;}
    .ctaRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .cta{
      flex:1; min-width:200px;
      border:none; border-radius:14px;
      padding:12px; font-weight:1000; cursor:pointer;
    }
    .cta.primary{background:var(--accent);color:#fff;}
    .cta.secondary{background:#fff;border:1px solid var(--line);}

    /* Confetti */
    .confetti{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
    }
    .dot{
      position:absolute;
      width:10px;height:10px;border-radius:50%;
      opacity:0.9;
      animation: fall 2.6s linear forwards;
    }
    @keyframes fall{
      0%{transform:translateY(-20px) rotate(0deg);opacity:1}
      100%{transform:translateY(520px) rotate(360deg);opacity:0.9}
    }

    /* Gentle feedback */
    .card.correct{ box-shadow: 0 0 0 3px rgba(111,168,161,.35); }
    .card.wrong{   box-shadow: 0 0 0 3px rgba(242,201,138,.45); }
  </style>
</head>

<body>
  <div class="app">
    <div class="top" id="top">

      <!-- Celebration overlay -->
      <div class="celebrate" id="celebrate">
        <div class="celebrateCard">

          <!-- FX sounds -->
          <audio id="fx_success" src="sounds/success.mp3" preload="auto"></audio>
          <audio id="fx_fail"    src="sounds/fail.mp3"    preload="auto"></audio>
          <audio id="fx_cheer"   src="sounds/cheer.mp3"   preload="auto"></audio>

          <div class="confetti" id="confetti"></div>
          <div style="font-size:54px">üéâ</div>
          <div class="big" id="celebrateTitle">Barakalla! üéâ</div>
          <p class="small" id="celebrateText">Siz 1-darsni tugatdingiz! Juda zo‚Äòr! üåü</p>
          <div id="stickerLine" class="small" style="font-weight:1000;">üè∑Ô∏è Stiker: ‚Äî</div>

          <div class="ctaRow">
            <button class="cta primary" onclick="goNext()">‚û°Ô∏è Keyingi dars</button>
            <button class="cta secondary" onclick="restartLesson()">üîÅ Qaytadan</button>
          </div>
        </div>
      </div>

      <!-- Header -->
      <div class="headRow">
        <div>
          <h1 id="title">üëã 1-dars: Salomlashuv</h1>
          <div class="sub" id="subtitle">Eshit, takrorla, o‚Äòyna! ‚≠ê</div>
        </div>

        <div class="langSwitch">
          <button id="btn-uz" class="langBtn active" onclick="setLang('uz')">UZ</button>
          <button id="btn-en" class="langBtn" onclick="setLang('en')">EN</button>
        </div>
      </div>

      <!-- Name setup -->
      <div class="bar">
        <div class="barRow">
          <div style="font-weight:1000">üëßüßí Isming nima?</div>
          <div style="color:var(--muted);font-weight:1000" id="childHello">Salom! üòä</div>
        </div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <input id="childNameInput" placeholder="Masalan: Damian"
            style="flex:1; min-width:220px; padding:12px; border-radius:14px; border:1px solid var(--line); font-weight:900;">
          <button class="audioBtn" id="saveNameBtn" style="flex:0; min-width:160px; background:var(--accent); color:#fff;">
            ‚úÖ Saqlash
          </button>
        </div>

        <div style="margin-top:10px; color:var(--muted); font-weight:900;" id="nameTip">
          Ism saqlanadi. Keyin ham shu ism bilan davom etasan.
        </div>
      </div>

      <!-- Progress -->
      <div class="bar">
        <div class="barRow">
          <div style="font-weight:1000" id="progressLabel">Darsdagi natija</div>
          <div style="color:var(--muted);font-weight:1000" id="progressText">0 / 5</div>
        </div>
        <div class="track"><div class="fill" id="progressFill"></div></div>
      </div>

      <!-- Cards -->
      <div class="grid" id="grid"></div>

      <!-- Mini-Game -->
      <div class="bar" style="margin-top:14px;">
        <div class="barRow">
          <div style="font-weight:1000">üòä Mini-o‚Äòyin: Qaysi so‚Äòz?</div>
          <div style="color:var(--muted);font-weight:1000" id="friendlyScore">0 / 3</div>
        </div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="audioBtn" id="friendlyStartBtn" style="flex:1; min-width:200px; background:var(--accent); color:#fff;">
            ‚ñ∂ Boshlash
          </button>
          <button class="audioBtn" id="friendlyRepeatBtn" style="flex:1; min-width:200px;">
            üîÅ Yana eshitish
          </button>
        </div>

        <div style="margin-top:10px; font-weight:900; color:var(--muted);" id="friendlyHint">
          ‚ÄúBoshlash‚Äùni bosing, so‚Äòzni eshiting va mos belgini tanlang.
        </div>

        <div class="opts" style="margin-top:10px;" id="friendlyOpts"></div>
        <div class="result" id="friendlyRes"></div>
      </div>

      <!-- Nav -->
      <div class="navRow">
        <a class="nav" href="index.html" id="homeBtn">‚¨ÖÔ∏è Bosh sahifa</a>
        <a class="next" href="lesson2.html" id="nextBtn">Keyingi ‚û°Ô∏è</a>
      </div>

    </div>
  </div>

<script>
  // =============================
  // CONFIG + DATA
  // =============================
  const STORAGE_KEY = "lesson1_state_v3";     // stable state key
  const NAME_KEY    = "kids_child_name_v1";
  const STICKER_KEY = "kids_stickers_v1";

  const items = [
    { key:"1",  emoji:"üëã", uz:"Salom",        en:"Hello",        pr:"sa-LOM",
      quiz: { uzQ:"‚ÄúSalom‚Äù nimani anglatadi?", enQ:"What does ‚ÄúSalom‚Äù mean?",
              correctEn:"Hello", wrongEn:["Thank you","Bye"] } },
    { key:"6",  emoji:"üôè", uz:"Rahmat",       en:"Thank you",    pr:"rakh-MAT",
      quiz: { uzQ:"‚ÄúRahmat‚Äù nimani anglatadi?", enQ:"What does ‚ÄúRahmat‚Äù mean?",
              correctEn:"Thank you", wrongEn:["Please","Hello"] } },
    { key:"9",  emoji:"üå∏", uz:"Iltimos",      en:"Please",       pr:"il-ti-MOS",
      quiz: { uzQ:"‚ÄúIltimos‚Äù nimani anglatadi?", enQ:"What does ‚ÄúIltimos‚Äù mean?",
              correctEn:"Please", wrongEn:["Sorry","Bye"] } },
    { key:"4",  emoji:"üôÇ", uz:"Yaxshimisiz?", en:"How are you?", pr:"yakh-shi-MI-siz",
      quiz: { uzQ:"‚ÄúYaxshimisiz?‚Äù nimani anglatadi?", enQ:"What does ‚ÄúYaxshimisiz?‚Äù mean?",
              correctEn:"How are you?", wrongEn:["Good night","Thank you"] } },
    { key:"11", emoji:"üåô", uz:"Xayr",         en:"Bye",          pr:"khayr",
      quiz: { uzQ:"‚ÄúXayr‚Äù nimani anglatadi?", enQ:"What does ‚ÄúXayr‚Äù mean?",
              correctEn:"Bye", wrongEn:["Hello","Please"] } },
  ];

  const ui = {
    uz: {
      title: "üëã 1-dars: Salomlashuv",
      subtitle: "Eshit, takrorla, o‚Äòyna! ‚≠ê",
      progressLabel: "Darsdagi natija",
      home: "‚¨ÖÔ∏è Bosh sahifa",
      next: "Keyingi ‚û°Ô∏è",
      listen: "‚ñ∂ Tinglash",
      quizTitle: "üéØ Mini-test",
      correctMsg: "‚úÖ To‚Äòg‚Äòri! Barakalla!",
      wrongMsg: "‚ùå Xato. Yana urinib ko‚Äòr!",
      celebrateTitle: "Barakalla! üéâ",
      celebrateText: "Siz 1-darsni tugatdingiz! Juda zo‚Äòr! üåü",
      quizDone: "‚úÖ Bajarildi",
      quizOpen: "‚ùì Test",
      resetOne: "‚Ü©Ô∏è Qaytarish"
    },
    en: {
      title: "üëã Lesson 1: Greetings",
      subtitle: "Listen, repeat, play! ‚≠ê",
      progressLabel: "Lesson progress",
      home: "‚¨ÖÔ∏è Home",
      next: "Next ‚û°Ô∏è",
      listen: "‚ñ∂ Listen",
      quizTitle: "üéØ Mini quiz",
      correctMsg: "‚úÖ Correct! Great job!",
      wrongMsg: "‚ùå Oops! Try again!",
      celebrateTitle: "Well done! üéâ",
      celebrateText: "You finished Lesson 1! Amazing! üåü",
      quizDone: "‚úÖ Done",
      quizOpen: "‚ùì Quiz",
      resetOne: "‚Ü©Ô∏è Reset"
    }
  };

  let currentLang = "uz";

  // =============================
  // STATE
  // =============================
  function getDefaultState(){
    return { stars:{}, quizDone:{}, celebrated:false };
  }
  function loadState(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
  function getState(){
    const s = loadState();
    const d = getDefaultState();
    return {
      stars: s.stars || d.stars,
      quizDone: s.quizDone || d.quizDone,
      celebrated: !!s.celebrated
    };
  }

  // =============================
  // CHILD NAME
  // =============================
  function getChildName(){ return (localStorage.getItem(NAME_KEY) || "").trim(); }
  function setChildName(name){
    const clean = (name || "").trim().slice(0, 20);
    if(clean) localStorage.setItem(NAME_KEY, clean);
  }
  function updateNameUI(){
    const n = getChildName();
    const hello = document.getElementById("childHello");
    const input = document.getElementById("childNameInput");
    if(hello) hello.innerText = n ? `Salom, ${n}! üòä` : "Salom! üòä";
    if(input) input.value = n || "";
  }
  function bindNameEvents(){
    const btn = document.getElementById("saveNameBtn");
    const input = document.getElementById("childNameInput");
    if(!btn || !input) return;

    btn.addEventListener("click", ()=>{
      setChildName(input.value);
      updateNameUI();
      btn.innerText = "‚úÖ Saqlandi!";
      setTimeout(()=> btn.innerText = "‚úÖ Saqlash", 900);
      updateProgress(false);
    });

    input.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") btn.click();
    });
  }

  // =============================
  // STICKERS
  // =============================
  function getStickers(){
    try { return JSON.parse(localStorage.getItem(STICKER_KEY) || "[]"); }
    catch { return []; }
  }
  function saveStickers(list){
    localStorage.setItem(STICKER_KEY, JSON.stringify(list));
  }
  function addStickerOnce(stickerId, stickerLabel){
    const list = getStickers();
    const exists = list.some(s => s.id === stickerId);
    if(exists) return list;
    list.push({ id: stickerId, label: stickerLabel, date: new Date().toISOString() });
    saveStickers(list);
    return list;
  }

  // =============================
  // FX AUDIO
  // =============================
  function playFx(which){
    const id =
      which === "success" ? "fx_success" :
      which === "fail"    ? "fx_fail" :
      "fx_cheer";
    const a = document.getElementById(id);
    if(!a) return;
    a.pause();
    a.currentTime = 0;
    a.play().catch(()=>{});
  }

  // =============================
  // UTILS
  // =============================
  function starText(n){
    n = Math.max(0, Math.min(3, n));
    return "‚òÖ".repeat(n) + "‚òÜ".repeat(3-n);
  }
  function shuffle(arr){
    const a = [...arr];
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }
  function flashEmoji(cardEl, face){
    if(!cardEl) return;
    const emojiEl = cardEl.querySelector(".emoji");
    if(!emojiEl) return;
    const old = emojiEl.innerText;
    emojiEl.innerText = face;
    setTimeout(()=>{ emojiEl.innerText = old; }, 600);
  }

  // =============================
  // LANGUAGE
  // =============================
  function setLang(lang){
    currentLang = lang;
    document.getElementById("btn-uz").classList.toggle("active", lang==="uz");
    document.getElementById("btn-en").classList.toggle("active", lang==="en");

    const T = ui[lang];
    document.getElementById("title").innerText = T.title;
    document.getElementById("subtitle").innerText = T.subtitle;
    document.getElementById("progressLabel").innerText = T.progressLabel;
    document.getElementById("homeBtn").innerText = T.home;
    document.getElementById("nextBtn").innerText = T.next;

    render();
    renderFriendlyOptions(); // mini-game labels update
    updateNameUI();
  }

  // =============================
  // RENDER CARDS
  // =============================
  function render(){
    const T = ui[currentLang];
    const state = getState();

    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    items.forEach(it=>{
      const stars = state.stars[it.key] || 0;
      const done = !!state.quizDone[it.key];
      const options = shuffle([it.quiz.correctEn, ...it.quiz.wrongEn]);

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="emoji">${it.emoji}</div>

        <div class="uz" style="display:${currentLang==='uz'?'block':'none'}">${it.uz}</div>
        <div class="en" style="display:${currentLang==='en'?'block':'none'}">${it.en}</div>

        <div class="pr">${it.pr}</div>

        <button class="audioBtn" data-key="${it.key}">${T.listen}</button>
        <div class="stars" id="star-${it.key}">${starText(stars)}</div>

        <audio id="uz_${it.key}" src="a/${it.key}.mp3" preload="none" playsinline></audio>
        <audio id="en_${it.key}" src="en/${it.key}.mp3" preload="none" playsinline></audio>

        <div class="quizWrap">
          <div class="qTitle">
            <span>${T.quizTitle}</span>

            <div style="display:flex;gap:8px;align-items:center;">
              <span style="font-weight:1000;color:${done?'var(--good)':'var(--muted)'}">
                ${done ? T.quizDone : T.quizOpen}
              </span>

              ${done ? `<button class="opt resetOne" data-reset="${it.key}" style="padding:6px 10px;">${T.resetOne}</button>` : ``}
            </div>
          </div>

          <p class="qText">${currentLang==='uz' ? it.quiz.uzQ : it.quiz.enQ}</p>

          <div class="opts">
            ${options.map(opt => `
              <button class="opt" data-qkey="${it.key}" data-opt="${opt}" ${done ? "disabled" : ""}>${opt}</button>
            `).join("")}
          </div>

          <div class="result" id="res-${it.key}"></div>
        </div>
      `;

      grid.appendChild(card);
    });

    // audio buttons
    grid.querySelectorAll(".audioBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.getAttribute("data-key");
        playWordAudio(key);
      });
    });

    // options + reset buttons
    grid.querySelectorAll(".opt").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const resetKey = btn.getAttribute("data-reset");
        if(resetKey){
          resetOne(resetKey);
          return;
        }
        const key = btn.getAttribute("data-qkey");
        const opt = btn.getAttribute("data-opt");
        if(!key || !opt) return;
        checkQuiz(key, opt);
      });
    });

    updateProgress(false);
  }

  // =============================
  // WORD AUDIO + STARS
  // =============================
  function playWordAudio(key){
    const id = (currentLang === "en") ? ("en_" + key) : ("uz_" + key);
    const a = document.getElementById(id);
    if(!a) return;

    a.currentTime = 0;
    a.play().catch(()=>{});

    const state = getState();
    state.stars[key] = Math.min(3, (state.stars[key] || 0) + 1);
    saveState(state);

    const starEl = document.getElementById("star-"+key);
    if(starEl) starEl.innerText = starText(state.stars[key]);
  }

  // =============================
  // QUIZ
  // =============================
  function checkQuiz(key, chosen){
    const T = ui[currentLang];
    const item = items.find(x=>x.key===key);
    if(!item) return;

    const state = getState();
    if(state.quizDone[key]) return;

    const res = document.getElementById("res-"+key);
    if(!res) return;

    const card = res.closest(".card");
    const isCorrect = (chosen === item.quiz.correctEn);

    if(isCorrect){
      flashEmoji(card, "üòä");
      if(card){
        card.classList.add("correct");
        setTimeout(()=>card.classList.remove("correct"), 450);
      }

      const n = getChildName();
      res.className = "result good";
      res.innerText = n ? `‚úÖ To‚Äòg‚Äòri, ${n}! Barakalla!` : T.correctMsg;
      playFx("success");

      // mastered word
      state.stars[key] = 3;
      state.quizDone[key] = true;
      saveState(state);

      updateProgress(true);
      render();
    } else {
      flashEmoji(card, "üòê");
      if(card){
        card.classList.add("wrong");
        setTimeout(()=>card.classList.remove("wrong"), 450);
      }

      res.className = "result bad";
      res.innerText = T.wrongMsg;
      playFx("fail");
    }
  }

  // =============================
  // PROGRESS + CELEBRATE
  // =============================
  function updateProgress(checkCelebrate){
    const state = getState();
    const doneCount = Object.values(state.quizDone || {}).filter(Boolean).length;

    const n = getChildName();
    const base = `${doneCount} / ${items.length}`;
    document.getElementById("progressText").innerText =
      n ? `${n}, sen ${base} bajarding!` : base;

    const pct = Math.round((doneCount / items.length) * 100);
    document.getElementById("progressFill").style.width = pct + "%";

    if(checkCelebrate && doneCount === items.length){
      if(!state.celebrated){
        state.celebrated = true;
        saveState(state);
        celebrate();
      }
    }
  }

  function celebrate(){
    const T = ui[currentLang];
    const n = getChildName();

    // mark lesson done for roadmap unlock
    localStorage.setItem("lesson1_done", "1");

    // sticker
    const stickerId = "lesson1_friendliness";
    const stickerLabel = "Do‚Äòstona so‚Äòzlar üíõ";
    addStickerOnce(stickerId, stickerLabel);

    const line = document.getElementById("stickerLine");
    if(line) line.innerText = "üè∑Ô∏è Stiker: " + stickerLabel;

    // texts with name
    document.getElementById("celebrateTitle").innerText = n ? `Barakalla, ${n}! üéâ` : T.celebrateTitle;
    document.getElementById("celebrateText").innerText  = n ? `${n}, siz 1-darsni tugatdingiz! Juda zo‚Äòr! üåü` : T.celebrateText;

    // show overlay
    document.getElementById("celebrate").classList.add("show");

    // confetti
    const conf = document.getElementById("confetti");
    conf.innerHTML = "";
    const colors = ["#F59E0B","#EF4444","#10B981","#3B82F6","#A855F7","#F97316"];
    for(let i=0;i<60;i++){
      const d = document.createElement("div");
      d.className = "dot";
      d.style.left = Math.random()*100 + "%";
      d.style.top  = (-20 - Math.random()*200) + "px";
      d.style.background = colors[Math.floor(Math.random()*colors.length)];
      d.style.animationDelay = (Math.random()*0.3) + "s";
      d.style.animationDuration = (1.8 + Math.random()*1.2) + "s";
      conf.appendChild(d);
    }

    // ‚úÖ keep cheer
    playFx("cheer");
  }

  // =============================
  // RESET
  // =============================
  function resetOne(key){
    const state = getState();
    state.quizDone[key] = false;
    state.stars[key] = 0;
    state.celebrated = false;
    saveState(state);

    document.getElementById("celebrate").classList.remove("show");
    render();
  }

  function restartLesson(){
    saveState(getDefaultState());
    document.getElementById("celebrate").classList.remove("show");
    render();
    // mini-game reset
    resetFriendlyGame();
  }

  function goNext(){
    window.location.href = "lesson2.html";
  }

  // =============================
  // MINI-GAME (Salom/Rahmat/Iltimos)
  // =============================
  const FRIENDLY_EMOJIS = [
    { emoji:"üëã", uz:"Salom",   en:"Hello" },
    { emoji:"üôè", uz:"Rahmat",  en:"Thank you" },
    { emoji:"üå∏", uz:"Iltimos", en:"Please" }
  ];
  const FRIENDLY_GAME_KEYS = ["1","6","9"];

  let friendlyGame = { order:[], idx:0, currentKey:null, score:0 };

  function initFriendlyGame(){
    const startBtn = document.getElementById("friendlyStartBtn");
    const repeatBtn = document.getElementById("friendlyRepeatBtn");
    if(startBtn) startBtn.addEventListener("click", startFriendlyGame);
    if(repeatBtn) repeatBtn.addEventListener("click", repeatFriendlyAudio);
    updateFriendlyScore();
    renderFriendlyOptions();
  }

  function renderFriendlyOptions(){
    const wrap = document.getElementById("friendlyOpts");
    if(!wrap) return;

    wrap.innerHTML = FRIENDLY_EMOJIS.map(x => `
      <button class="opt" data-friendly="${x.emoji}">
        <span style="font-size:22px; margin-right:8px;">${x.emoji}</span>
        <span>${currentLang === "uz" ? x.uz : x.en}</span>
      </button>
    `).join("");

    wrap.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const chosenEmoji = btn.getAttribute("data-friendly");
        checkFriendlyAnswer(chosenEmoji);
      });
    });
  }

  function setFriendlyHint(text){
    const hint = document.getElementById("friendlyHint");
    if(hint) hint.innerText = text;
  }

  function clearFriendlyResult(){
    const res = document.getElementById("friendlyRes");
    if(!res) return;
    res.className = "result";
    res.innerText = "";
  }

  function showFriendlyResult(ok, text){
    const res = document.getElementById("friendlyRes");
    if(!res) return;
    res.className = ok ? "result good" : "result bad";
    res.innerText = text;
  }

  function updateFriendlyScore(){
    const el = document.getElementById("friendlyScore");
    if(el) el.innerText = `${friendlyGame.score} / ${FRIENDLY_GAME_KEYS.length}`;
  }

  function startFriendlyGame(){
    friendlyGame.order = shuffle(FRIENDLY_GAME_KEYS);
    friendlyGame.idx = 0;
    friendlyGame.score = 0;

    setFriendlyHint(currentLang === "uz"
      ? "üéß Eshit! Qaysi so‚Äòz?"
      : "üéß Listen! Which word?"
    );

    nextFriendlyRound();
    updateFriendlyScore();
  }

  function nextFriendlyRound(){
    clearFriendlyResult();

    if(friendlyGame.idx >= friendlyGame.order.length){
      setFriendlyHint(currentLang === "uz"
        ? "üéâ O‚Äòyin tugadi! Barakalla!"
        : "üéâ Game finished!"
      );
      showFriendlyResult(true, `${friendlyGame.score} / ${FRIENDLY_GAME_KEYS.length}`);
      return;
    }

    friendlyGame.currentKey = friendlyGame.order[friendlyGame.idx];
    playFriendlyWord(friendlyGame.currentKey);
  }

  function playFriendlyWord(key){
    const id = (currentLang === "en") ? ("en_" + key) : ("uz_" + key);
    const a = document.getElementById(id);
    if(!a){
      setFriendlyHint("‚ö†Ô∏è Audio topilmadi: " + key);
      return;
    }
    a.pause(); a.currentTime = 0;
    a.play().catch(()=>{});
  }

  function repeatFriendlyAudio(){
    if(!friendlyGame.currentKey){
      setFriendlyHint(currentLang === "uz" ? "üëâ Avval ‚ÄúBoshlash‚Äùni bosing." : "üëâ Press Start first.");
      return;
    }
    playFriendlyWord(friendlyGame.currentKey);
  }

  function checkFriendlyAnswer(chosenEmoji){
    const key = friendlyGame.currentKey;
    if(!key) return;

    const correctEmoji =
      key === "1" ? "üëã" :
      key === "6" ? "üôè" :
      key === "9" ? "üå∏" :
      null;

    const resCardAnchor = document.getElementById("res-"+key);
    const card = resCardAnchor ? resCardAnchor.closest(".card") : null;

    if(chosenEmoji === correctEmoji){
      friendlyGame.score++;
      playFx("success");

      flashEmoji(card, "üòä");
      if(card){
        card.classList.add("correct");
        setTimeout(()=>card.classList.remove("correct"), 450);
      }

      showFriendlyResult(true, currentLang === "uz" ? "‚úÖ To‚Äòg‚Äòri!" : "‚úÖ Correct!");
      friendlyGame.idx++;
      updateFriendlyScore();
      setTimeout(nextFriendlyRound, 500);
    } else {
      playFx("fail");

      flashEmoji(card, "üòê");
      if(card){
        card.classList.add("wrong");
        setTimeout(()=>card.classList.remove("wrong"), 450);
      }

      showFriendlyResult(false, currentLang === "uz" ? "‚ùå Xato, yana!" : "‚ùå Try again!");
    }
  }

  function resetFriendlyGame(){
    friendlyGame = { order:[], idx:0, currentKey:null, score:0 };
    updateFriendlyScore();
    clearFriendlyResult();
    setFriendlyHint("‚ÄúBoshlash‚Äùni bosing, so‚Äòzni eshiting va mos belgini tanlang.");
  }

  // =============================
  // INIT
  // =============================
  (function init(){
    if(!localStorage.getItem(STORAGE_KEY)){
      saveState(getDefaultState());
    }
    bindNameEvents();
    updateNameUI();
    initFriendlyGame();
    setLang("uz");
  })();
</script>
</body>
</html>


