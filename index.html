<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dono Bola! (4‚Äì6)</title>

  <style>
    :root{
      --ink:#0f172a;
      --muted:#475569;
      --line:rgba(15,23,42,.12);
      --shadow:0 14px 30px rgba(2,6,23,.12);
      --radius:22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      padding:16px;
      min-height:100vh;
      overflow-x:hidden;

      background:
        linear-gradient(180deg, rgba(223,247,240,.92), rgba(234,246,255,.92)),
        url("data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27720%27%20height%3D%27720%27%20viewBox%3D%270%200%20720%20720%27%3E%3Crect%20width%3D%27720%27%20height%3D%27720%27%20fill%3D%27%23f7fbff%27/%3E%3Cg%20opacity%3D%270.22%27%3E%3Cg%20transform%3D%27translate(40%2C40)%27%3E%3Cpath%20d%3D%27M120%200%20L160%2040%20L120%2080%20L80%2040%20Z%27%20fill%3D%27%230ea5a4%27/%3E%3Cpath%20d%3D%27M120%20110%20L170%20160%20L120%20210%20L70%20160%20Z%27%20fill%3D%27%2322c55e%27/%3E%3Cpath%20d%3D%27M120%20240%20L160%20280%20L120%20320%20L80%20280%20Z%27%20fill%3D%27%23f59e0b%27/%3E%3Cpath%20d%3D%27M0%20120%20L40%20160%20L0%20200%20L-40%20160%20Z%27%20fill%3D%27%2314b8a6%27/%3E%3Cpath%20d%3D%27M240%20120%20L280%20160%20L240%20200%20L200%20160%20Z%27%20fill%3D%27%2310b981%27/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      background-size: cover, 720px 720px;
      background-attachment: fixed, fixed;
    }

    .app{max-width:860px;margin:0 auto}
    .top{
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(6px);
      position:relative;
      overflow:hidden;
    }
    .top.premiumGlow{
      box-shadow: 0 0 0 8px rgba(34,197,94,.15), var(--shadow);
      transition: box-shadow .35s ease;
    }

    /* Header */
    .hero{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;justify-content:space-between}
    .heroLeft{display:flex;gap:14px;align-items:center;flex-wrap:wrap}

    .sunWrap{width:104px;height:104px;flex:0 0 auto}
    .sun{
      width:104px;height:104px;border-radius:999px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 30%, #fff6cc, #fbbf24 55%, #f59e0b 100%);
      box-shadow: 0 12px 28px rgba(245,158,11,.36);
      border: 5px solid rgba(255,255,255,.72);
    }
    .sunPct{font-weight:1000;font-size:22px;color:#7c2d12;text-shadow:0 2px 0 rgba(255,255,255,.35)}

    h1{margin:0;font-size:24px;font-weight:1000;letter-spacing:.2px}
    .helloBig{
      margin-top:6px;
      font-weight:1000;
      font-size:40px;
      line-height:1.05;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .helloBig .name{color:#065f46;text-shadow:0 2px 0 rgba(255,255,255,.45)}

    .topActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
      position:relative;
    }
    .langBtn,.profileBtn{
      border-radius:18px;
      font-weight:1000;
      border:1px solid rgba(15,23,42,.14);
      cursor:pointer;
      user-select:none;
      padding:12px 14px;
      background: rgba(255,255,255,.94);
      font-size:16px;
      white-space:nowrap;
    }
    .profileBtn{display:flex;align-items:center;gap:10px}

    .profileMenu{
      position:absolute;
      right:0;
      top:52px;
      width:240px;
      background: rgba(255,255,255,.97);
      border:1px solid rgba(15,23,42,.12);
      border-radius:18px;
      box-shadow: 0 18px 36px rgba(2,6,23,.16);
      padding:8px;
      display:none;
      z-index:50;
    }
    .profileMenu.show{display:block}
    .menuItem{
      width:100%;
      text-align:left;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid transparent;
      background:transparent;
      font-weight:900;
      cursor:pointer;
      font-size:16px;
    }
    .menuItem:hover{background: rgba(15,23,42,.06)}
    .menuItem:active{transform: translateY(1px)}

    /* Progress */
    .barWrap{
      margin-top:12px;
      background:rgba(255,255,255,.96);
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow: 0 12px 28px rgba(2,6,23,.07);
    }
    .barRow{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
    .barLabel{font-weight:1000;font-size:18px}
    .barText{color:var(--muted);font-weight:1000;font-size:16px}
    .bar{
      margin-top:12px;
      height:18px;
      background: rgba(15,23,42,.10);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(15,23,42,.10);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      border-radius:999px;
      transition: width .45s ease;
    }

    .achRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .achIcon{
      width:46px;height:46px;border-radius:999px;
      display:grid;place-items:center;
      font-size:24px;
      background: rgba(34,197,94,.18);
      border:2px solid rgba(34,197,94,.35);
      box-shadow: 0 14px 28px rgba(2,6,23,.10);
    }

    /* Lesson list + visible path */
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
      position:relative;
      padding-left:30px;
    }
    .grid::before{
      content:"";
      position:absolute;
      left:12px;
      top:10px;
      bottom:10px;
      width:12px;
      border-radius:999px;
      background: linear-gradient(180deg,
        rgba(34,197,94,.55),
        rgba(59,130,246,.45),
        rgba(245,158,11,.45)
      );
      border:2px solid rgba(15,23,42,.10);
      box-shadow: 0 18px 40px rgba(2,6,23,.12);
    }

    /* Step dot */
    .stepDot{
      position:absolute;
      left:-28px;
      top:50%;
      transform: translateY(-50%);
      width:38px;height:38px;border-radius:999px;
      background: rgba(255,255,255,.98);
      border:3px solid rgba(15,23,42,.22);
      box-shadow: 0 16px 34px rgba(2,6,23,.12);
      z-index:2;
    }
    .tile.done .stepDot{border-color: rgba(34,197,94,.70); background: rgba(34,197,94,.25);}
    .tile.current .stepDot{border-color: rgba(245,158,11,.80); background: rgba(245,158,11,.25);}

    /* ===== TILE ===== */
    .tile{
      border:2px solid rgba(15,23,42,.10);
      border-radius:28px;
      box-shadow: 0 18px 38px rgba(2,6,23,.14);
      padding:16px;
      text-decoration:none;
      color:inherit;
      position:relative;
      overflow:hidden;
      touch-action: manipulation;
      cursor:pointer;
      background: rgba(255,255,255,.97);

      display:grid;
      grid-template-columns: clamp(64px, 18vw, 92px) 1fr auto; /* responsive */
      grid-template-areas: "icon title tag";
      align-items:center;
      gap: clamp(10px, 2.4vw, 14px);
      min-height: clamp(110px, 22vw, 150px);
    }
    .tile:active{transform: translateY(1px)}
    .tile.locked{opacity:.78; filter: grayscale(.16);}

    /* Emoji icon only (responsive) */
    .icon{
      grid-area: icon;
      width: clamp(64px, 18vw, 92px);
      height: clamp(64px, 18vw, 92px);
      display:grid;
      place-items:center;
      font-size: clamp(48px, 12vw, 72px);
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      border-radius:0 !important;
      z-index:2;
    }

    /* Title (responsive) */
    .title{
      grid-area: title;
      font-size: clamp(20px, 5vw, 36px);
      font-weight:1000;
      line-height:1.05;
      letter-spacing:.2px;

      display:flex;
      align-items:center;
      justify-content:flex-start;
      text-align:left;

      min-width:0;
      overflow-wrap:anywhere;
      hyphens:auto;
      padding: 0 8px;
      z-index:2;
    }

    /* ===== STATUS: NO FRAME (text only) ===== */
    .tagRight{
      grid-area: tag;
      justify-self:end;
      align-self:center;

      display:flex;
      flex-direction:column;
      align-items:flex-end;
      justify-content:center;
      gap:2px;

      padding: 0;
      min-width: 0;
      border: none;
      background: transparent;
      box-shadow: none;
      z-index:2;
    }
    .tagRight .main{
      font-size: clamp(14px, 3.4vw, 20px);
      font-weight:1100;
      letter-spacing:.6px;
      white-space:nowrap;
    }
    .tagRight .sub{
      font-size: clamp(10px, 2.6vw, 12px);
      font-weight:900;
      letter-spacing:.2px;
      color: rgba(15,23,42,.60);
      white-space:nowrap;
    }

    .tagRight.open{ color:#065f46; }
    .tagRight.lock{ color: rgba(15,23,42,.70); }

    /* Bottom line (kept) */
    .tile::after{
      content:"";
      position:absolute;
      left:16px;
      right:16px;
      bottom:10px;
      height:16px;
      border-radius:999px;
      background: var(--soft, rgba(0,0,0,.06));
      border:1px solid rgba(15,23,42,.06);
      opacity:.95;
      z-index:0;
    }

    /* Bottom buttons */
    .btnRow{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
    .btnWide{
      flex:1;min-width:240px;
      text-align:center;
      padding:16px;
      border-radius:20px;
      font-weight:1000;
      border:1px solid transparent;
      cursor:pointer;
      user-select:none;
      font-size:18px;
    }
    .btnWide.primary{
      background: linear-gradient(180deg, #34d399, #22c55e);
      color:#052e1b;
      border-color: rgba(5,46,27,.10);
      box-shadow: 0 18px 40px rgba(34,197,94,.22);
    }
    .btnWide.secondary{
      background: rgba(255,255,255,.96);
      color: var(--ink);
      border-color: var(--line);
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%) translateY(10px);
      background: rgba(255,255,255,.94);
      border:1px solid rgba(15,23,42,.12);
      box-shadow: 0 18px 40px rgba(2,6,23,.18);
      border-radius:999px;
      padding:12px 16px;
      font-weight:1000;
      opacity:0;
      pointer-events:none;
      transition: opacity .22s ease, transform .22s ease;
      z-index:20000;
      max-width: 92vw;
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* Gates */
    .gate{
      position:fixed; inset:0;
      z-index:10000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:
        radial-gradient(circle at 25% 15%, rgba(255,255,255,.18), transparent 35%),
        radial-gradient(circle at 80% 25%, rgba(255,255,255,.14), transparent 40%),
        rgba(2,6,23,.55);
      backdrop-filter: blur(10px) saturate(1.1);
    }
    .gate.show{display:flex}

    /* Pop-in animation */
    .gateCard{
      width:min(520px, 92vw);
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.35);
      border-radius:26px;
      box-shadow: 0 22px 70px rgba(2,6,23,.35);
      padding:16px;
      text-align:center;

      transform: translateY(16px) scale(.98);
      opacity:0;
      transition: transform .22s ease, opacity .22s ease;
    }
    .gate.show .gateCard{transform: translateY(0) scale(1);opacity:1}

    .gateTitle{font-size:24px;font-weight:1000;margin:6px 0 6px}
    .gateText{
      margin:0 0 12px;
      font-weight:900;
      font-size:17px;
      color: rgba(15,23,42,.82);
      line-height:1.35;
    }
    #paywallMain{display:block;font-size:18px;margin-bottom:6px}
    #paywallSub{display:block;font-size:14px;color: rgba(15,23,42,.62)}

    .nameInput{
      width:min(360px, 86vw);
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.18);
      font-weight:1000;
      font-size:18px;
      outline:none;
      background: rgba(255,255,255,.95);
    }
    .nameInput:focus{border-color: rgba(59,130,246,.55);box-shadow: 0 0 0 6px rgba(59,130,246,.18);}

    .gateBtn{
      width:min(360px, 86vw);
      margin-top:10px;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(5,46,27,.10);
      background: linear-gradient(180deg, #34d399, #22c55e);
      color:#052e1b;
      font-weight:1000;
      cursor:pointer;
      font-size:18px;
    }

    @keyframes pulseSoft{
      0%,100%{ transform: translateY(0); filter: saturate(1); }
      50%{ transform: translateY(-1px); filter: saturate(1.15); }
    }
    .gateBtn.pulse{
      animation: pulseSoft 1.2s ease-in-out infinite;
      box-shadow: 0 16px 38px rgba(34,197,94,.25);
    }

    .btnGhost{
      width:min(360px, 86vw);
      margin-top:10px;
      padding:14px;
      border-radius:18px;
      border:1px dashed rgba(15,23,42,.22);
      background: rgba(255,255,255,.92);
      color: rgba(15,23,42,.88);
      font-weight:1000;
      cursor:pointer;
      font-size:16px;
    }
    .gateHint{margin-top:10px;font-size:12.5px;font-weight:900;color: rgba(15,23,42,.62);}

    /* Mobile header: text next to sun */
    @media (max-width: 420px){
      .hero{ gap:12px; }
      .heroLeft{ flex-wrap: nowrap; align-items: center; gap:12px; width: 100%; }
      .sunWrap{ width:78px; height:78px; }
      .sun{ width:78px; height:78px; }
      .sunPct{ font-size:18px; }
      .heroLeft > div:last-child{ flex:1; min-width:0; }

      h1{ font-size:18px; line-height:1.1; margin:0; }
      .helloBig{ font-size:28px; margin-top:4px; line-height:1.05; }

      .topActions{ gap:8px; }
      .langBtn,.profileBtn{ padding:10px 12px; font-size:15px; }

      .grid{ padding-left:22px; }
      .grid::before{ left:8px; width:10px; }
      .stepDot{ left:-22px; width:30px; height:30px; }

      .tile{
        padding:14px;
        gap: 12px;
      }
    }

    @media (min-width: 768px){
      .app{max-width:760px;}
      .helloBig{font-size:46px;}
      /* title/icon/tag are already responsive with clamp() */
      .tile{min-height:150px;}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top" id="topCard">

      <div class="hero">
        <div class="heroLeft">
          <div class="sunWrap" aria-hidden="true">
            <div class="sun"><div class="sunPct" id="mainPct">0%</div></div>
          </div>

          <div>
            <h1>üåø Dono Bola!</h1>
            <div class="helloBig">
              <span>ü¶Å</span>
              <span id="helloWord">Hello,</span>
              <span class="name" id="childNameBig">Friend!</span>
              <span>‚ú®</span>
            </div>
          </div>
        </div>

        <div class="topActions">
          <button class="langBtn" id="langBtn" type="button">UZ</button>

          <button class="profileBtn" id="profileBtn" type="button" aria-haspopup="menu" aria-expanded="false">
            üßí <span id="profileName">Friend</span> ‚ñæ
          </button>

          <div class="profileMenu" id="profileMenu" role="menu">
            <button class="menuItem" id="changeNameBtn" type="button">‚úèÔ∏è Change name</button>
          </div>
        </div>
      </div>

      <div class="barWrap">
        <div class="barRow">
          <div class="barLabel" id="progressLabel">‚≠ê Progress</div>
          <div class="barText" id="progressText">0 / 93</div>
          <div class="achRow" id="achRow"></div>
        </div>
        <div class="bar">
          <div class="fill" id="progressFill"></div>
        </div>
      </div>

      <div class="grid" id="lessonGrid"></div>

      <div class="btnRow">
        <button class="btnWide primary" id="premiumBtn" type="button">üîì Premium</button>
        <button class="btnWide secondary" id="resetBtn" type="button">‚ôªÔ∏è Reset</button>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Name Gate -->
  <div class="gate" id="nameGate">
    <div class="gateCard" role="dialog" aria-modal="true">
      <div style="font-size:44px; line-height:1;">üßí‚ú®</div>
      <div class="gateTitle" id="nameGateTitle">What‚Äôs your name?</div>
      <p class="gateText" id="nameGateText">Type your name ‚úçÔ∏è</p>
      <input class="nameInput" id="nameInput" type="text" autocomplete="name"
             placeholder="Example: Ali" maxlength="18" />
      <button class="gateBtn" id="startBtn" type="button">Start üöÄ</button>
      <div class="gateHint" id="nameGateHint">Tip: 2 letters is enough üôÇ</div>
    </div>
  </div>

  <!-- Paywall Gate -->
  <div class="gate" id="paywallGate">
    <div class="gateCard" role="dialog" aria-modal="true">
      <div style="font-size:44px; line-height:1;">üîì‚ú®</div>
      <div class="gateTitle" id="paywallTitle">Premium</div>

      <p class="gateText">
        <span id="paywallMain">Unlock all lessons üîì</span>
        <span id="paywallSub">One-time payment: $9.99. Then everything is unlocked forever ‚úÖ</span>
      </p>

      <button class="gateBtn pulse" id="buyBtn" type="button">Buy Premium ‚Äî $9.99</button>
      <button class="btnGhost" id="closePaywallBtn" type="button">Close</button>

      <div class="gateHint" id="paywallHint">GitHub demo now. Real payment later in the app stores.</div>
    </div>
  </div>

<script>
  const PREMIUM_KEY = "premium_unlocked";
  const CHILD_KEY   = "childName";
  const LANG_KEY    = "ui_lang";
  const PRICE_LABEL = "$9.99";

  const UI = {
    en: {
      langBtn: "UZ",
      helloWord: "Hello,",
      friendFallback: "Friend!",
      profileChangeName: "‚úèÔ∏è Change name",
      progressLabel: "‚≠ê Progress",
      openLabel: "OPEN",
      freeLabel: "FREE",
      lessonLabel: (id)=> `Lesson ${id}`,
      paywallTitle: "Premium",
      paywallText: (id)=> `Premium is required for Lesson ${id}.`,
      paywallOneTime: (price)=> `One-time payment: ${price}. Then everything is unlocked forever ‚úÖ`,
      buyBtn: (price)=> `Buy Premium ‚Äî ${price}`,
      close: "Close",
      hint: "GitHub demo now. Real payment later in the app stores.",
      nameGateTitle: "What‚Äôs your name?",
      nameGateText: "Type your name ‚úçÔ∏è",
      namePlaceholder: "Example: Ali",
      startBtn: "Start üöÄ",
      nameGateHint: "Tip: 2 letters is enough üôÇ",
      resetConfirm: "Start over? (Progress will be cleared)",
      premiumActivated: "‚úÖ Premium activated (demo)!"
    },
    uz: {
      langBtn: "ENG",
      helloWord: "Salom,",
      friendFallback: "Do‚Äòst!",
      profileChangeName: "‚úèÔ∏è Ismni o‚Äòzgartirish",
      progressLabel: "‚≠ê Yutuq",
      openLockedLabel: "OCHMOQ",
      openUnlockedLabel: "OCHIQ",
      freeLabel: "BEPUL",
      lessonLabel: (id)=> `${id}-dars`,
      paywallTitle: "Premium",
      paywallText: (id)=> `${id}-dars uchun Premium kerak üîí`,
      paywallOneTime: (price)=> `Bir marta to‚Äòlov: ${price}. Keyin hammasi umrbod ochiq ‚úÖ`,
      buyBtn: (price)=> `Premium sotib olish ‚Äî ${price}`,
      close: "Yopish",
      hint: "Hozir GitHub demo. Keyin haqiqiy to‚Äòlov bo‚Äòladi.",
      nameGateTitle: "Isming nima?",
      nameGateText: "Ismingni yoz ‚úçÔ∏è",
      namePlaceholder: "Masalan: Ali",
      startBtn: "Boshlaymiz! üöÄ",
      nameGateHint: "Maslahat: 2 ta harf yetadi üôÇ",
      resetConfirm: "Hammasini qaytadan boshlaymizmi? (Natija o‚Äòchadi)",
      premiumActivated: "‚úÖ Premium (demo) aktiv!"
    }
  };

  function getLang(){
    const v = localStorage.getItem(LANG_KEY);
    return (v === "uz" || v === "en") ? v : "en";
  }
  function setLang(v){ localStorage.setItem(LANG_KEY, v); }
  function T(){ return UI[getLang()]; }

  const MIN_WORDS_PER_LESSON = { 1:5,2:5,3:5,4:5,5:5,6:5,7:5,8:5,9:5,10:5 };

  function getLearnedSet(){
    try { return new Set(JSON.parse(localStorage.getItem("learned") || "[]")); }
    catch { return new Set(); }
  }

  const LESSONS = [
    { id: 1, file:"lesson1.html", icon:"üëã", en:"Greetings",      uz:"Salomlashuv" },
    { id: 2, file:"lesson2.html", icon:"üî¢", en:"Numbers",        uz:"Sonlar" },
    { id: 3, file:"lesson3.html", icon:"üêæ", en:"Animals",        uz:"Hayvonlar" },
    { id: 4, file:"lesson4.html", icon:"üé®", en:"Colors",         uz:"Ranglar" },
    { id: 5, file:"lesson5.html", icon:"üçé", en:"Fruits",         uz:"Mevalar" },
    { id: 6, file:"lesson6.html", icon:"ü•ï", en:"Vegetables",     uz:"Sabzavot" },
    { id: 7, file:"lesson7.html", icon:"üè†", en:"Home",           uz:"Uy" },
    { id: 8, file:"lesson8.html", icon:"üëï", en:"Clothes",        uz:"Kiyim" },
    { id: 9, file:"lesson9.html", icon:"üöó", en:"Transport",      uz:"Transport" },
    { id:10, file:"lesson10.html",icon:"üåô", en:"Daily routine",  uz:"Kun tartibi" }
  ];

  const COLORS = [
    { bg:"rgba(251, 113, 133, .42)", soft:"rgba(251, 113, 133, .18)" },
    { bg:"rgba(251, 146,  60, .45)", soft:"rgba(251, 146,  60, .18)" },
    { bg:"rgba(250, 204,  21, .45)", soft:"rgba(250, 204,  21, .18)" },
    { bg:"rgba( 34, 197,  94, .38)", soft:"rgba( 34, 197,  94, .16)" },
    { bg:"rgba( 20, 184, 166, .40)", soft:"rgba( 20, 184, 166, .16)" },
    { bg:"rgba( 59, 130, 246, .40)", soft:"rgba( 59, 130, 246, .16)" },
    { bg:"rgba( 99, 102, 241, .42)", soft:"rgba( 99, 102, 241, .16)" },
    { bg:"rgba(168,  85, 247, .40)", soft:"rgba(168,  85, 247, .16)" },
    { bg:"rgba(236,  72, 153, .38)", soft:"rgba(236,  72, 153, .16)" },
    { bg:"rgba(100, 116, 139, .34)", soft:"rgba(100, 116, 139, .14)" }
  ];

  const TOTAL_WORDS = 93;

  function isPremium(){ return localStorage.getItem(PREMIUM_KEY) === "true"; }
  function setPremium(v){ localStorage.setItem(PREMIUM_KEY, v ? "true" : "false"); }

  function normalizeName(s){ return (s || "").trim().replace(/\s+/g, " ").slice(0, 18); }

  function lessonLearnedCount(learnedSet, lessonId){
    let c = 0;
    const prefix = "L" + lessonId + "_";
    for (const key of learnedSet){
      if (key.startsWith(prefix)) c++;
    }
    return c;
  }

  function isLessonCompleted(learnedSet, lessonId){
    const need = MIN_WORDS_PER_LESSON[lessonId] ?? 1;
    return lessonLearnedCount(learnedSet, lessonId) >= need;
  }

  function canOpenLesson(lessonId){
    if(lessonId === 1) return true;
    return isPremium();
  }

  function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(()=> t.classList.remove("show"), 1900);
  }

  function openPaywall(lessonId){
    const gate = document.getElementById("paywallGate");
    const main = document.getElementById("paywallMain");
    const sub  = document.getElementById("paywallSub");
    const buy  = document.getElementById("buyBtn");
    const title= document.getElementById("paywallTitle");
    const tt = T();

    title.innerText = tt.paywallTitle;

    if(String(lessonId).toLowerCase() === "premium"){
      main.innerText = (getLang()==="uz") ? "Barcha darslar ochiladi üîì" : "Unlock all lessons üîì";
      sub.innerText  = tt.paywallOneTime(PRICE_LABEL);
    } else {
      main.innerText = tt.paywallText(lessonId);
      sub.innerText  = tt.paywallOneTime(PRICE_LABEL);
    }

    buy.innerText  = tt.buyBtn(PRICE_LABEL);
    buy.dataset.lessonId = String(lessonId);
    buy.classList.add("pulse");

    gate.classList.add("show");
  }
  function closePaywall(){ document.getElementById("paywallGate").classList.remove("show"); }

  function applyTexts(){
    const tt = T();
    document.getElementById("langBtn").innerText = tt.langBtn;
    document.getElementById("helloWord").innerText = tt.helloWord;
    document.getElementById("changeNameBtn").innerText = tt.profileChangeName;
    document.getElementById("progressLabel").innerText = tt.progressLabel;

    document.getElementById("nameGateTitle").innerText = tt.nameGateTitle;
    document.getElementById("nameGateText").innerText  = tt.nameGateText;
    document.getElementById("nameInput").placeholder   = tt.namePlaceholder;
    document.getElementById("startBtn").innerText      = tt.startBtn;
    document.getElementById("nameGateHint").innerText  = tt.nameGateHint;

    document.getElementById("closePaywallBtn").innerText = tt.close;
    document.getElementById("paywallHint").innerText  = tt.hint;
  }

  function applyGreeting(){
    const tt = T();
    const name = localStorage.getItem(CHILD_KEY) || "";
    const child = name ? name : tt.friendFallback;

    document.getElementById("childNameBig").innerText = child;
    document.getElementById("profileName").innerText = child.replace("!", "");
  }

  function showNameGate(){
    const gate = document.getElementById("nameGate");
    gate.classList.add("show");
    const input = document.getElementById("nameInput");
    const btn = document.getElementById("startBtn");

    btn.disabled = true;
    input.value = "";
    setTimeout(() => input.focus(), 50);

    const validate = () => { btn.disabled = normalizeName(input.value).length < 2; };
    input.oninput = validate;
    input.onkeydown = (e)=>{ if(e.key==="Enter" && !btn.disabled) btn.click(); };

    btn.onclick = () => {
      const nm = normalizeName(input.value);
      if(nm.length < 2) return;
      localStorage.setItem(CHILD_KEY, nm);
      gate.classList.remove("show");
      applyGreeting();
    };
  }

  function renderProgressIcons(){
    const learned = getLearnedSet();
    const row = document.getElementById("achRow");
    row.innerHTML = "";
    LESSONS.forEach(L=>{
      if(isLessonCompleted(learned, L.id)){
        const d = document.createElement("div");
        d.className = "achIcon";
        d.title = `Lesson ${L.id}`;
        d.textContent = L.icon;
        row.appendChild(d);
      }
    });
  }

  function renderLessons(){
    const tt = T();
    const learned = getLearnedSet();
    const premium = isPremium();

    const learnedCount = learned.size;
    const pct = Math.max(0, Math.min(100, Math.round((learnedCount / TOTAL_WORDS) * 100)));
    document.getElementById("mainPct").innerText = pct + "%";
    document.getElementById("progressText").innerText = `${learnedCount} / ${TOTAL_WORDS}`;
    document.getElementById("progressFill").style.width = pct + "%";

    const grid = document.getElementById("lessonGrid");
    grid.innerHTML = "";

    let current = 1;
    for(let i=1;i<=LESSONS.length;i++){
      if(!isLessonCompleted(learned, i)){ current = i; break; }
    }

    LESSONS.forEach((L, idx)=>{
      const open = canOpenLesson(L.id);
      const done = isLessonCompleted(learned, L.id);
      const isCurrent = (L.id === current);

      const c = COLORS[idx % COLORS.length];

      const a = document.createElement("a");
      a.className = "tile" + (open ? "" : " locked") + (done ? " done" : "") + (isCurrent ? " current" : "");
      a.href = open ? L.file : "#";
      a.style.background = `linear-gradient(180deg, ${c.bg}, rgba(255,255,255,.92))`;
      a.style.setProperty("--soft", c.soft);

      const step = document.createElement("div");
      step.className = "stepDot";
      a.appendChild(step);

      const icon = document.createElement("div");
      icon.className = "icon";
      icon.textContent = L.icon;
      a.appendChild(icon);

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = (getLang()==="uz") ? L.uz : L.en;
      a.appendChild(title);

      const isFree = (L.id === 1 && !premium);

      let mainLabel = "OPEN";
      if(getLang() === "uz"){
        if(isFree){
          mainLabel = tt.freeLabel; // BEPUL
        } else {
          mainLabel = premium ? tt.openUnlockedLabel : tt.openLockedLabel; // OCHIQ / OCHMOQ
        }
      } else {
        mainLabel = isFree ? tt.freeLabel : tt.openLabel; // FREE / OPEN
      }

      const tag = document.createElement("div");
      tag.className = "tagRight " + (open ? "open" : "lock");
      tag.innerHTML = `
        <span class="main">${mainLabel}</span>
        <span class="sub">${tt.lessonLabel(L.id)}</span>
      `;
      a.appendChild(tag);

      a.addEventListener("click", (e)=>{
        if(!open){
          e.preventDefault();
          openPaywall(L.id);
        }
      });

      grid.appendChild(a);
    });
  }

  function updateAll(){
    applyTexts();
    applyGreeting();
    renderProgressIcons();
    renderLessons();
  }

  function wireUI(){
    document.getElementById("langBtn").addEventListener("click", ()=>{
      const next = (getLang()==="en") ? "uz" : "en";
      setLang(next);
      updateAll();
    });

    const profileBtn = document.getElementById("profileBtn");
    const profileMenu = document.getElementById("profileMenu");

    profileBtn.addEventListener("click", ()=>{
      const isOpen = profileMenu.classList.toggle("show");
      profileBtn.setAttribute("aria-expanded", String(isOpen));
    });

    document.addEventListener("click", (e)=>{
      const inside = profileMenu.contains(e.target) || profileBtn.contains(e.target);
      if(!inside){
        profileMenu.classList.remove("show");
        profileBtn.setAttribute("aria-expanded","false");
      }
    });

    document.getElementById("changeNameBtn").addEventListener("click", ()=>{
      profileMenu.classList.remove("show");
      localStorage.removeItem(CHILD_KEY);
      showNameGate();
    });

    document.getElementById("premiumBtn").addEventListener("click", ()=> openPaywall("Premium"));

    document.getElementById("buyBtn").addEventListener("click", ()=>{
      setPremium(true);
      closePaywall();
      updateAll();

      const top = document.getElementById("topCard");
      top.classList.add("premiumGlow");
      setTimeout(()=> top.classList.remove("premiumGlow"), 1200);

      showToast(T().premiumActivated);
    });

    document.getElementById("closePaywallBtn").addEventListener("click", ()=> closePaywall());
    document.getElementById("paywallGate").addEventListener("click", (e)=>{
      if(e.target.id === "paywallGate") closePaywall();
    });

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      const ok = confirm(T().resetConfirm);
      if(!ok) return;
      localStorage.removeItem("learned");
      localStorage.removeItem(PREMIUM_KEY);
      updateAll();
    });

    window.addEventListener("focus", updateAll);
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) updateAll(); });
    window.addEventListener("pageshow", updateAll);
  }

  window.addEventListener("load", ()=>{
    wireUI();
    if(!localStorage.getItem(LANG_KEY)) setLang("en");
    const nm = localStorage.getItem(CHILD_KEY);
    if(!nm) showNameGate();
    updateAll();
  });
</script>
</body>
</html>
