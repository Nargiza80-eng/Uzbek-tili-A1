<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Dono Bola - 1. Dars</title>

  <style>
    :root {
      --bg: #f0f9ff;
      --primary: #0984e3;
      --success: #00b894;
      --error: #d63031;
      --sun: #fdcb6e;
      --radius: 25px;
    }

    body {
      margin: 0;
      font-family: 'Comic Sans MS', cursive;
      background: var(--bg);
      color: #2d3436;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      min-height: 100vh;
    }

    /* --- HEADER --- */
    .header-box {
      background: white; width: 100%; max-width: 520px;
      border-radius: var(--radius); padding: 15px; text-align: center;
      box-shadow: 0 8px 0 rgba(0,0,0,0.05); margin-bottom: 12px; border: 4px solid white;
    }

    .progress-container { background: #dfe6e9; height: 15px; border-radius: 10px; margin: 10px 0; overflow: hidden; }
    .progress-fill { background: var(--success); height: 100%; width: 0%; transition: width 0.5s; }

    .top-row { display:flex; justify-content: space-between; align-items:center; gap:10px; }
    .icon-btn { background:none; border:none; font-size:22px; cursor:pointer; }

    /* --- Language switch --- */
    .lang-switch{
      display:flex; gap:10px; justify-content:center;
      margin-top: 10px;
    }
    .lang-btn{
      padding:10px 14px; border-radius: 999px;
      border:none; background:#fff; cursor:pointer;
      box-shadow: 0 4px 0 #ccc; font-weight:bold; font-size:14px;
      min-width:70px;
    }
    .lang-btn.active{ background: var(--primary); color:#fff; box-shadow: 0 4px 0 #074b81; }

    /* --- MODUS NAVIGATION (bigger) --- */
    .mode-nav {
      display: flex; gap: 10px; margin-bottom: 14px;
      width: 100%; max-width: 520px; flex-wrap: wrap;
    }
    .mode-btn {
      flex: 1; padding: 14px 12px;
      border-radius: 18px; border: none; background: white;
      font-weight: 900; cursor: pointer;
      box-shadow: 0 5px 0 #ccc;
      font-size: 16px;
      min-width: 140px;
      white-space: nowrap;
    }
    .mode-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 0 #074b81; }

    /* --- SECTIONS --- */
    #learnSection, #quizSection, #memorySection, #echoSection, #bubbleSection {
      display: none; width: 100%; max-width: 520px; text-align: center;
    }
    #learnSection { display: grid; } /* default */

    /* --- LERN-KARTEN (bigger icons) --- */
    .learn-grid { display: grid; grid-template-columns: 1fr; gap: 16px; width: 100%; max-width: 520px; }
    .learn-card {
      background: white; border-radius: var(--radius); padding: 22px;
      display: flex; align-items: center; gap: 16px;
      box-shadow: 0 8px 0 #dfe6e9; border: 3px solid white;
    }
    .learn-emoji { font-size: 64px; width: 78px; text-align:center; }
    .learn-info { text-align: left; flex: 1; }
    .learn-main { font-weight:900; font-size:22px; }
    .learn-sub { color:#636e72; font-size:16px; margin-top:2px; }
    .stars { margin-top: 8px; font-weight: 900; color: #f39c12; font-size: 18px; }

    .btn-audio {
      background: var(--sun); border: none; width: 62px; height: 62px;
      border-radius: 50%; font-size: 26px; cursor: pointer;
      box-shadow: 0 5px 0 #e67e22;
    }
    .btn-audio:active { transform: translateY(3px); box-shadow: 0 2px 0 #e67e22; }

    /* --- QUIZ --- */
    .quiz-card { background: white; border-radius: 30px; padding: 28px; box-shadow: 0 10px 0 #dfe6e9; }
    .quiz-emoji { font-size: 96px; margin-top: 4px; }
    .option-btn {
      width: 100%; padding: 16px; margin: 10px 0; border-radius: 20px;
      border: 3px solid #f1f2f6; background: white; font-size: 18px; font-weight: 900; cursor: pointer;
      box-shadow: 0 5px 0 #f1f2f6;
    }
    .option-btn:active { transform: translateY(2px); box-shadow: none; }

    /* --- MEMORY --- */
    .memory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .memory-card {
      height: 112px; background: var(--primary); border-radius: 18px;
      display: flex; justify-content: center; align-items: center;
      font-size: 28px; color: white; cursor: pointer;
      box-shadow: 0 6px 0 #074b81;
      user-select:none; padding:8px; text-align:center;
    }
    .memory-card.flipped { background: white; color: #2d3436; box-shadow: 0 6px 0 #ccc; }
    .memory-card.matched { visibility: hidden; }

    /* --- ALBUM --- */
    .album-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      z-index: 1000; justify-content: center; align-items: center;
    }
    .album-content { background: white; padding: 26px; border-radius: 30px; text-align: center; width: 85%; max-width: 380px; }
    .sticker-slot {
      width: 70px; height: 70px; background: #eee; border-radius: 50%;
      display: inline-flex; justify-content: center; align-items: center;
      font-size: 34px; opacity: 0.2; filter: grayscale(1); margin: 6px;
      border: 2px dashed #bbb;
    }
    .sticker-slot.unlocked { opacity: 1; filter: none; background: #fff9e6; border: 3px solid var(--sun); }

    /* --- ECHO --- */
    .lion-big { font-size: 130px; margin: 14px; transition: 0.3s; display: inline-block; }
    .talking { animation: mouthMove 0.3s infinite; }
    @keyframes mouthMove { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.1); } }

    .mic-btn-huge{
      width: 130px; height: 130px; border-radius: 50%; border: none;
      background: #ff4757; color: white; font-size: 54px; cursor: pointer;
      box-shadow: 0 10px 0 #b33939; margin: 14px;
      touch-action: manipulation;
    }
    .mic-btn-huge:active { transform: translateY(6px); box-shadow: 0 4px 0 #b33939; }
    .mic-btn-huge.active { background: #2ed573; box-shadow: 0 4px 0 #1c9e54; transform: translateY(6px); }

    .banner{
      background:white; padding:15px; border-radius:30px;
      border:4px solid #70a1ff;
      font-size:26px; font-weight:900;
      margin-bottom:10px;
    }
    .small-note{ font-weight:900; color:#334155; font-size:16px; margin-top:6px; }
    .speech-line{
      margin-top:10px;
      padding:12px;
      border-radius:18px;
      background:#fff;
      border:3px dashed #d0d7de;
      font-weight:900;
      color:#111827;
      min-height: 24px;
    }
    .speech-ok{ border-color:#86efac; background:#ecfdf5; }
    .speech-bad{ border-color:#fecaca; background:#fef2f2; }

    /* --- BUBBLES --- */
    #bubbleArea{
      position: relative; width: 100%; height: 60vh;
      background: linear-gradient(#70a1ff, #1e90ff); border-radius: 30px;
      border: 8px solid white; overflow: hidden; margin-top: 10px;
    }
    .bubble{
      position: absolute; width: 110px; height: 110px; background: rgba(255,255,255,0.55);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 54px; border: 3px solid white; animation: floatUp 4s linear forwards;
      cursor: pointer; user-select:none;
    }
    @keyframes floatUp { 0% { transform: translateY(65vh); } 100% { transform: translateY(-15vh); } }

    /* --- CELEBRATION OVERLAY --- */
    .celebrate-overlay{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,0.75);
      z-index: 2000;
      align-items:center; justify-content:center;
      padding: 16px;
    }
    .celebrate-overlay.show{ display:flex; }
    .celebrate-card{
      width: 100%;
      max-width: 520px;
      background: white;
      border-radius: 30px;
      padding: 22px;
      text-align:center;
      box-shadow: 0 14px 0 rgba(0,0,0,0.12);
      position: relative;
      overflow: hidden;
      border: 6px solid #fff;
    }
    .celebrate-emoji{ font-size: 72px; }
    .celebrate-title{ font-size: 28px; font-weight: 900; margin-top: 6px; }
    .celebrate-text{ color:#374151; font-weight: 800; margin-top: 8px; font-size: 16px; }
    .celebrate-btn{
      margin-top: 14px;
      width: 100%;
      padding: 14px;
      border-radius: 18px;
      border: none;
      background: var(--success);
      color: white;
      font-weight: 900;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 6px 0 #09725b;
    }
    .celebrate-btn:active{ transform: translateY(3px); box-shadow: 0 3px 0 #09725b; }

    .confetti{
      position:absolute; inset:0;
      pointer-events:none;
      overflow:hidden;
    }
    .dot{
      position:absolute;
      width: 10px; height: 10px;
      border-radius: 50%;
      opacity: 0.95;
      animation: fall 2.2s linear forwards;
    }
    @keyframes fall{
      0%{ transform: translateY(-20px) rotate(0deg); }
      100%{ transform: translateY(560px) rotate(360deg); opacity: 0.9; }
    }
  </style>
</head>

<body>

  <!-- Celebration Overlay -->
  <div class="celebrate-overlay" id="celebrateOverlay">
    <div class="celebrate-card">
      <div class="confetti" id="confetti"></div>
      <div class="celebrate-emoji" id="celebrateEmoji">üéâ</div>
      <div class="celebrate-title" id="celebrateTitle">Barakalla!</div>
      <div class="celebrate-text" id="celebrateText">Zo‚Äòr!</div>
      <button class="celebrate-btn" onclick="closeCelebrate()">OK ‚úÖ</button>
    </div>
  </div>

  <div class="header-box">
    <div class="top-row">
      <a href="index.html" style="text-decoration:none; font-size:22px;">üè†</a>
      <h3 style="margin:0;" id="titleText">1-dars: Salomlashuv</h3>
      <button onclick="toggleAlbum()" class="icon-btn" aria-label="Album">üìñ</button>
    </div>

    <div class="progress-container"><div class="progress-fill" id="progressFill"></div></div>
    <small id="progressText">0 / 5</small>

    <div class="lang-switch">
      <button class="lang-btn active" id="langUZ" onclick="setLang('uz')">UZ</button>
      <button class="lang-btn" id="langEN" onclick="setLang('en')">EN</button>
    </div>
  </div>

  <div class="mode-nav">
    <button class="mode-btn active" id="btnLearn"   onclick="changeMode('learn')">üìñ O'rganish</button>
    <button class="mode-btn"        id="btnQuiz"    onclick="changeMode('quiz')">üéØ Test</button>
    <button class="mode-btn"        id="btnMemory"  onclick="changeMode('memory')">üß† O'yin</button>
    <button class="mode-btn"        id="btnEcho"    onclick="changeMode('echo')">üó£Ô∏è Aks-sado</button>
    <button class="mode-btn"        id="btnBubble"  onclick="changeMode('bubble')">ü´ß Pufakchalar</button>
  </div>

  <!-- Learn -->
  <div id="learnSection" class="learn-grid"></div>

  <!-- Quiz -->
  <div id="quizSection">
    <div class="quiz-card">
      <div id="qEmoji" class="quiz-emoji">üëã</div>
      <h2 id="qWordMain" style="margin: 8px 0 10px; font-size: 34px;">Salom</h2>

      <button class="option-btn" style="background:var(--sun); border-color:#f39c12;" onclick="playCurrentQuizAudio()">
        üîä <span id="listenBtnText">Eshitish</span>
      </button>

      <div id="optionsBox"></div>
    </div>
  </div>

  <!-- Memory -->
  <div id="memorySection">
    <div id="memStats" style="margin-bottom:10px; font-weight:900; font-size:16px;">
      <span id="movesLabel">Urinishlar</span>: <span id="moves">0</span>
    </div>
    <div class="memory-grid" id="memoryGrid"></div>
  </div>

  <!-- Echo -->
  <div id="echoSection">
    <div id="lionChar" class="lion-big">ü¶Å</div>

    <div id="echoText" class="banner">Eshiting...</div>

    <div style="display:flex; justify-content:center; flex-wrap:wrap;">
      <button class="mic-btn-huge" style="background:#f1c40f; box-shadow: 0 10px 0 #c49f0a;" onclick="playEchoAudio()">üîä</button>
      <button class="mic-btn-huge" id="micBtn"
        onpointerdown="startMic()" onpointerup="stopMic()" onpointercancel="stopMic()">
        üé§
      </button>
    </div>

    <div class="small-note" id="echoHint">üîÅ Eshit ‚Üí ayt ‚Üí tekshir!</div>
    <div class="speech-line" id="speechLine">üéôÔ∏è ...</div>
    <div class="small-note" id="echoProgress">‚≠ê 0 / 5</div>
  </div>

  <!-- Bubbles -->
  <div id="bubbleSection">
    <div id="bubbleTask" class="banner">Top: ...</div>
    <div id="bubbleArea"></div>
    <div class="small-note" id="bubbleHint">Emoji top! ‚≠ê</div>
    <div class="small-note" id="bubbleScoreLine">‚≠ê 0 / 5</div>
  </div>

  <!-- Album -->
  <div id="albumOverlay" class="album-overlay" onclick="toggleAlbum()">
    <div class="album-content" onclick="event.stopPropagation()">
      <h3 id="albumTitle" style="margin-top:0;">Mening Stikerlarim</h3>
      <div id="stk_1" class="sticker-slot">üëã</div>
      <div id="stk_2" class="sticker-slot">üî¢</div>
      <div id="stk_3" class="sticker-slot">ü¶Å</div>
      <br><br>
      <button class="mode-btn" onclick="toggleAlbum()" id="closeAlbumBtn">Yopish</button>
    </div>
  </div>

<script>
  // =========================
  // DATA
  // =========================
  const data = [
    { key: "1",  emoji: "üëã", uz: "Salom",        en: "Hello" },
    { key: "6",  emoji: "üôè", uz: "Rahmat",       en: "Thank you" },
    { key: "9",  emoji: "üå∏", uz: "Iltimos",      en: "Please" },
    { key: "4",  emoji: "üôÇ", uz: "Yaxshimisiz?", en: "How are you?" },
    { key: "11", emoji: "üåô", uz: "Xayr",         en: "Bye" }
  ];

  // =========================
  // UI TEXTS
  // =========================
  const UI = {
    uz: {
      title: "1-dars: Salomlashuv",
      learn: "üìñ O'rganish",
      quiz: "üéØ Test",
      memory: "üß† O'yin",
      echo: "üó£Ô∏è Aks-sado",
      bubble: "ü´ß Pufakchalar",
      listen: "Eshitish",
      moves: "Urinishlar",
      album: "Mening Stikerlarim",
      close: "Yopish",
      echoHint: "üîÅ Eshit ‚Üí ayt ‚Üí tekshir!",
      bubbleHint: "To‚Äòg‚Äòri emojini top! ‚≠ê",
      bubbleTask: "Top: ",
      doneQuizTitle: "Barakalla! üéâ",
      doneQuizText: "Siz testni tugatdingiz! Stiker oldingiz! üëã",
      winMemoryTitle: "Zo‚Äòr! ü¶Å",
      winMemoryText: "Memory o‚Äòyinini yutdingiz! Stiker oldingiz!",
      winBubbleTitle: "Ajoyib! ü´ß",
      winBubbleText: "Pufakchalar o‚Äòyinini tugatdingiz! Stiker oldingiz! üî¢",
      echoWinTitle: "Zo‚Äòr! üó£Ô∏è",
      echoWinText: "Aks-sado o‚Äòyinini tugatdingiz! ‚≠ê",
      sayAgain: "‚ùå Xato. Yana urinib ko‚Äòr!",
      micNoSupport: "‚ö†Ô∏è Brauzer mic-ni qo‚Äòllamaydi. Chrome ishlating."
    },
    en: {
      title: "Lesson 1: Greetings",
      learn: "üìñ Learn",
      quiz: "üéØ Quiz",
      memory: "üß† Game",
      echo: "üó£Ô∏è Echo",
      bubble: "ü´ß Bubbles",
      listen: "Listen",
      moves: "Moves",
      album: "My Stickers",
      close: "Close",
      echoHint: "üîÅ Listen ‚Üí say it ‚Üí check!",
      bubbleHint: "Find the correct emoji! ‚≠ê",
      bubbleTask: "Tap: ",
      doneQuizTitle: "Well done! üéâ",
      doneQuizText: "You finished the quiz! You earned a sticker! üëã",
      winMemoryTitle: "You won! ü¶Å",
      winMemoryText: "You beat the memory game! Sticker unlocked!",
      winBubbleTitle: "Amazing! ü´ß",
      winBubbleText: "You finished the bubbles game! Sticker unlocked! üî¢",
      echoWinTitle: "Great! üó£Ô∏è",
      echoWinText: "You finished Echo! ‚≠ê",
      sayAgain: "‚ùå Not quite. Try again!",
      micNoSupport: "‚ö†Ô∏è Mic not supported. Use Chrome."
    }
  };

  let currentLang = "uz";

  // =========================
  // STORAGE
  // =========================
  const STARS_KEY = "lesson1_stars_v2";
  const QUIZ_DONE_KEY = "lesson1_quiz_done_v2";
  const STICKERS_KEY = "stickers";

  function loadStars(){
    try { return JSON.parse(localStorage.getItem(STARS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveStars(st){ localStorage.setItem(STARS_KEY, JSON.stringify(st)); }
  function starText(n){
    n = Math.max(0, Math.min(3, n));
    return "‚òÖ".repeat(n) + "‚òÜ".repeat(3-n);
  }

  function loadQuizDone(){
    try { return JSON.parse(localStorage.getItem(QUIZ_DONE_KEY) || "[]"); }
    catch { return []; }
  }
  function saveQuizDone(arr){ localStorage.setItem(QUIZ_DONE_KEY, JSON.stringify(arr)); }
  function quizDoneCount(){ return loadQuizDone().length; }

  function updateProgress(){
    const done = quizDoneCount();
    const pct = (done / data.length) * 100;
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressText').innerText = `${done} / ${data.length}`;
  }

  // =========================
  // CELEBRATION
  // =========================
  function celebrate(title, text, emoji="üéâ"){
    document.getElementById("celebrateEmoji").innerText = emoji;
    document.getElementById("celebrateTitle").innerText = title;
    document.getElementById("celebrateText").innerText = text;

    const conf = document.getElementById("confetti");
    conf.innerHTML = "";
    const colors = ["#F59E0B","#EF4444","#10B981","#3B82F6","#A855F7","#F97316"];
    for(let i=0;i<70;i++){
      const d = document.createElement("div");
      d.className = "dot";
      d.style.left = (Math.random()*100) + "%";
      d.style.top = (-30 - Math.random()*220) + "px";
      d.style.background = colors[Math.floor(Math.random()*colors.length)];
      d.style.animationDelay = (Math.random()*0.25) + "s";
      d.style.animationDuration = (1.6 + Math.random()*1.1) + "s";
      conf.appendChild(d);
    }

    document.getElementById("celebrateOverlay").classList.add("show");
    sfxWin();
  }

  function closeCelebrate(){
    document.getElementById("celebrateOverlay").classList.remove("show");
  }

  // =========================
  // MODE + LANG
  // =========================
  function setLang(lang){
    currentLang = lang;
    document.getElementById("langUZ").classList.toggle("active", lang==="uz");
    document.getElementById("langEN").classList.toggle("active", lang==="en");

    const T = UI[lang];
    document.getElementById("titleText").innerText = T.title;
    document.getElementById("btnLearn").innerText = T.learn;
    document.getElementById("btnQuiz").innerText = T.quiz;
    document.getElementById("btnMemory").innerText = T.memory;
    document.getElementById("btnEcho").innerText = T.echo;
    document.getElementById("btnBubble").innerText = T.bubble;
    document.getElementById("listenBtnText").innerText = T.listen;
    document.getElementById("movesLabel").innerText = T.moves;
    document.getElementById("albumTitle").innerText = T.album;
    document.getElementById("closeAlbumBtn").innerText = T.close;
    document.getElementById("echoHint").innerText = T.echoHint;
    document.getElementById("bubbleHint").innerText = T.bubbleHint;

    renderLearn();
    loadQuiz();

    // refresh game banners if open
    if(document.getElementById("echoSection").style.display === "block") playEchoAudio();
    if(document.getElementById("bubbleSection").style.display === "block") startBubbles();
  }

  function changeMode(mode) {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');

    document.getElementById('learnSection').style.display = 'none';
    document.getElementById('quizSection').style.display = 'none';
    document.getElementById('memorySection').style.display = 'none';
    document.getElementById('echoSection').style.display = 'none';
    document.getElementById('bubbleSection').style.display = 'none';

    stopBubbles();
    stopRecognition();

    if(mode === 'learn'){ document.getElementById('learnSection').style.display='grid'; renderLearn(); }
    if(mode === 'quiz'){  document.getElementById('quizSection').style.display='block'; loadQuiz(); }
    if(mode === 'memory'){document.getElementById('memorySection').style.display='block'; initMemory(); }
    if(mode === 'echo'){  document.getElementById('echoSection').style.display='block'; startEchoGame(); }
    if(mode === 'bubble'){document.getElementById('bubbleSection').style.display='block'; startBubbles(); }
  }

  // =========================
  // AUDIO
  // =========================
  function audioPath(key){
    return currentLang === "en" ? `en/${key}.mp3` : `a/${key}.mp3`;
  }
  function playAudio(key){
    const a = new Audio(audioPath(key));
    a.play().catch(()=>{});
    return a;
  }

  // =========================
  // LEARN
  // =========================
  function renderLearn() {
    const stars = loadStars();
    const container = document.getElementById('learnSection');
    container.innerHTML = '';

    data.forEach(item => {
      const s = stars[item.key] || 0;
      const main = (currentLang === "en") ? item.en : item.uz;
      const sub  = (currentLang === "en") ? item.uz : item.en;

      const div = document.createElement('div');
      div.className = 'learn-card';
      div.innerHTML = `
        <div class="learn-emoji">${item.emoji}</div>
        <div class="learn-info">
          <div class="learn-main">${main}</div>
          <div class="learn-sub">${sub}</div>
          <div class="stars" id="star_${item.key}">${starText(s)}</div>
        </div>
        <button class="btn-audio" data-key="${item.key}">üîä</button>
      `;
      container.appendChild(div);
    });

    container.querySelectorAll('.btn-audio').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.getAttribute('data-key');
        playAudio(key);

        const st = loadStars();
        st[key] = Math.min(3, (st[key] || 0) + 1);
        saveStars(st);

        const starEl = document.getElementById('star_' + key);
        if(starEl) starEl.innerText = starText(st[key]);
      });
    });
  }

  // =========================
  // QUIZ (bilingual)
  // =========================
  let currentQuizIdx = 0;

  function playCurrentQuizAudio(){
    const item = data[currentQuizIdx];
    playAudio(item.key);
  }

  function loadQuiz() {
    updateProgress();

    const done = loadQuizDone();
    let safety = 0;
    while(done.includes(data[currentQuizIdx].key) && safety < 20){
      currentQuizIdx = (currentQuizIdx + 1) % data.length;
      safety++;
    }

    if(done.length === data.length){
      document.getElementById('qEmoji').innerText = "üéâ";
      document.getElementById('qWordMain').innerText = (currentLang==="en") ? "Quiz completed!" : "Test tugadi!";
      document.getElementById('optionsBox').innerHTML =
        `<button class="option-btn" onclick="restartQuiz()">üîÅ Restart</button>`;
      return;
    }

    const item = data[currentQuizIdx];
    document.getElementById('qEmoji').innerText = item.emoji;

    const qWord = (currentLang === "en") ? item.en : item.uz;
    document.getElementById('qWordMain').innerText = qWord;

    const correct = (currentLang === "en") ? item.uz : item.en;
    const pool = data.map(x => (currentLang === "en") ? x.uz : x.en);

    let choices = [correct];
    while(choices.length < 3) {
      const r = pool[Math.floor(Math.random()*pool.length)];
      if(!choices.includes(r)) choices.push(r);
    }
    choices.sort(() => Math.random() - 0.5);

    const box = document.getElementById('optionsBox');
    box.innerHTML = '';

    choices.forEach(c => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.innerText = c;

      btn.onclick = () => {
        if(c === correct) {
          btn.style.background = 'var(--success)'; btn.style.color = 'white';

          const doneList = loadQuizDone();
          if(!doneList.includes(item.key)){
            doneList.push(item.key);
            saveQuizDone(doneList);
          }

          // reward: set stars to 3
          const st = loadStars();
          st[item.key] = 3;
          saveStars(st);

          setTimeout(() => {
            currentQuizIdx = (currentQuizIdx + 1) % data.length;

            if(loadQuizDone().length === data.length){
              unlockSticker(1);
              const T = UI[currentLang];
              celebrate(T.doneQuizTitle, T.doneQuizText, "üëã");
            }

            updateProgress();
            loadQuiz();
          }, 420);
        } else {
          btn.style.background = 'var(--error)'; btn.style.color = 'white';
          setTimeout(() => { btn.style.background = 'white'; btn.style.color = '#2d3436'; }, 600);
        }
      };

      box.appendChild(btn);
    });
  }

  function restartQuiz(){
    saveQuizDone([]);
    currentQuizIdx = 0;
    updateProgress();
    loadQuiz();
  }

  // =========================
  // MEMORY
  // =========================
  let flippedCards = [];
  let moves = 0;
  let matches = 0;

  function initMemory() {
    const grid = document.getElementById('memoryGrid');
    grid.innerHTML = '';
    moves = 0; matches = 0;
    flippedCards = [];
    document.getElementById('moves').innerText = moves;

    let cards = [];
    data.forEach(item => {
      const word = (currentLang === "en") ? item.en : item.uz;
      cards.push({ id: item.key, val: item.emoji });
      cards.push({ id: item.key, val: word });
    });
    cards.sort(() => Math.random() - 0.5);

    cards.forEach(c => {
      const div = document.createElement('div');
      div.className = 'memory-card';
      div.innerText = "‚ùì";

      div.onclick = () => {
        if(flippedCards.length < 2 && !div.classList.contains('flipped') && !div.classList.contains('matched')) {
          div.classList.add('flipped');
          div.innerText = c.val;
          flippedCards.push({ div, id: c.id });

          if(flippedCards.length === 2) {
            moves++;
            document.getElementById('moves').innerText = moves;

            setTimeout(() => {
              if(flippedCards[0].id === flippedCards[1].id) {
                flippedCards.forEach(f => f.div.classList.add('matched'));
                matches++;
                if(matches === data.length) {
                  unlockSticker(3);
                  const T = UI[currentLang];
                  celebrate(T.winMemoryTitle, T.winMemoryText, "ü¶Å");
                }
              } else {
                flippedCards.forEach(f => {
                  f.div.classList.remove('flipped');
                  f.div.innerText = "‚ùì";
                });
              }
              flippedCards = [];
            }, 800);
          }
        }
      };

      grid.appendChild(div);
    });
  }

  // =========================
  // SFX (offline beeps)
  // =========================
  let audioCtx = null;
  function beep(freq=700, dur=0.12){
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;
    if(!audioCtx) audioCtx = new AC();
    if(audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "triangle";
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.12, audioCtx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + dur);
  }
  function sfxWin(){ beep(660,0.12); setTimeout(()=>beep(880,0.14),140); setTimeout(()=>beep(990,0.16),300); }
  function sfxPop(){ beep(520,0.08); }
  function sfxFail(){ beep(220,0.15); setTimeout(()=>beep(180,0.18),120); }

  // =========================
  // ECHO (finite: each word once) + SPEECH RECOGNITION
  // =========================
  let echoOrder = [];
  let echoIdx = 0;
  let recognition = null;
  let isRecognizing = false;

  function shuffle(arr){
    const a = [...arr];
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function startEchoGame(){
    echoOrder = shuffle(data.map(x=>x.key)); // each word once
    echoIdx = 0;
    updateEchoProgress();
    setSpeechLine("üéôÔ∏è ...", "");
    playEchoAudio();
  }

  function currentEchoItem(){
    const key = echoOrder[echoIdx];
    return data.find(x=>x.key===key);
  }

  function updateEchoProgress(){
    const el = document.getElementById("echoProgress");
    if(el) el.innerText = `‚≠ê ${echoIdx} / ${data.length}`;
  }

  function playEchoAudio() {
    const item = currentEchoItem();
    if(!item) return;

    const word = (currentLang === "en") ? item.en : item.uz;
    document.getElementById('echoText').innerText = word;

    const lion = document.getElementById('lionChar');
    lion.classList.add('talking');
    const a = playAudio(item.key);
    a.onended = () => lion.classList.remove('talking');
  }

  function normalizeText(s){
    return (s || "")
      .toLowerCase()
      .replace(/[‚Äò‚Äô`]/g, "'")
      .replace(/[^a-z–∞-—è—ë“õ“ì“≥—û—å—ä'\s?-]/gi, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function setSpeechLine(text, state){ // state: "ok" | "bad" | ""
    const el = document.getElementById("speechLine");
    el.className = "speech-line" + (state==="ok" ? " speech-ok" : state==="bad" ? " speech-bad" : "");
    el.innerText = text;
  }

  function startMic() {
    const T = UI[currentLang];
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition){
      setSpeechLine(T.micNoSupport, "bad");
      sfxFail();
      return;
    }

    // prepare
    if(isRecognizing) return;

    recognition = new SpeechRecognition();
    recognition.lang = (currentLang === "en") ? "en-US" : "uz-UZ"; // uz-UZ may fallback internally
    recognition.interimResults = false;
    recognition.maxAlternatives = 3;

    isRecognizing = true;
    document.getElementById('micBtn').classList.add('active');
    document.getElementById('lionChar').innerText = "üëÇ";
    setSpeechLine("üéôÔ∏è ...", "");

    recognition.onresult = (event) => {
      const item = currentEchoItem();
      const target = normalizeText((currentLang==="en") ? item.en : item.uz);

      const transcript = normalizeText(event.results[0][0].transcript);
      setSpeechLine("üó£Ô∏è " + transcript, "");

      // tolerant matching: allow includes / small variations
      const ok =
        transcript === target ||
        transcript.includes(target) ||
        target.includes(transcript);

      if(ok){
        setSpeechLine("‚úÖ " + transcript, "ok");
        sfxWin();

        echoIdx++;
        updateEchoProgress();

        if(echoIdx >= data.length){
          const TT = UI[currentLang];
          celebrate(TT.echoWinTitle, TT.echoWinText, "üó£Ô∏è");
          // restart next time entering echo
          stopMic();
          return;
        }

        setTimeout(() => {
          playEchoAudio();
        }, 650);

      } else {
        const TT = UI[currentLang];
        setSpeechLine(TT.sayAgain + " (" + transcript + ")", "bad");
        sfxFail();
        // keep same word, do not advance
      }
    };

    recognition.onerror = () => {
      const TT = UI[currentLang];
      setSpeechLine(TT.sayAgain, "bad");
      sfxFail();
    };

    recognition.onend = () => {
      isRecognizing = false;
      document.getElementById('micBtn').classList.remove('active');
      document.getElementById('lionChar').innerText = "ü¶Å";
    };

    recognition.start();
  }

  function stopRecognition(){
    try{
      if(recognition){
        recognition.stop();
      }
    }catch(e){}
    recognition = null;
    isRecognizing = false;
    document.getElementById('micBtn').classList.remove('active');
    document.getElementById('lionChar').innerText = "ü¶Å";
  }

  function stopMic(){
    stopRecognition();
  }

  // =========================
  // BUBBLES (finite: each word once)
  // =========================
  let bubbleInt = null;
  let bubbleOrder = [];
  let bubbleIdx = 0;
  let bubbleTarget = null;

  function stopBubbles(){
    if(bubbleInt){ clearInterval(bubbleInt); bubbleInt = null; }
  }

  function updateBubbleScoreLine(){
    const el = document.getElementById("bubbleScoreLine");
    if(el) el.innerText = `‚≠ê ${bubbleIdx} / ${data.length}`;
  }

  function startBubbles() {
    stopBubbles();

    // start a full finite round
    if(bubbleOrder.length === 0 || bubbleIdx === 0){
      bubbleOrder = shuffle(data.map(x=>x.key)); // each once
      bubbleIdx = 0;
    }

    if(bubbleIdx >= data.length){
      // finished
      unlockSticker(2);
      const T = UI[currentLang];
      celebrate(T.winBubbleTitle, T.winBubbleText, "ü´ß");
      bubbleIdx = 0;
      bubbleOrder = [];
      updateBubbleScoreLine();
      return;
    }

    const key = bubbleOrder[bubbleIdx];
    bubbleTarget = data.find(x=>x.key===key);

    const taskWord = (currentLang === "en") ? bubbleTarget.en : bubbleTarget.uz;
    const T = UI[currentLang];
    document.getElementById('bubbleTask').innerText = T.bubbleTask + taskWord;

    playAudio(bubbleTarget.key);

    const area = document.getElementById('bubbleArea');
    area.innerHTML = "";
    updateBubbleScoreLine();

    bubbleInt = setInterval(() => {
      const b = document.createElement('div');
      const randomItem = data[Math.floor(Math.random() * data.length)];

      b.className = 'bubble';
      b.innerText = randomItem.emoji;
      b.style.left = (Math.random() * 70 + 10) + '%';

      b.onclick = () => {
        sfxPop();

        if(randomItem.key === bubbleTarget.key) {
          b.innerText = '‚≠ê';
          b.style.background = '#2ed573';
          b.style.borderColor = '#fff';

          // next word
          bubbleIdx++;
          stopBubbles();
          setTimeout(startBubbles, 500);
        } else {
          b.innerText = 'üí®';
          setTimeout(() => b.remove(), 150);
        }
      };

      area.appendChild(b);
      setTimeout(() => b.remove(), 4000);
    }, 1200);
  }

  // =========================
  // ALBUM / STICKERS
  // =========================
  function toggleAlbum() {
    const album = document.getElementById('albumOverlay');
    album.style.display = (album.style.display === 'flex') ? 'none' : 'flex';

    const earned = JSON.parse(localStorage.getItem(STICKERS_KEY) || "[]");
    earned.forEach(id => {
      const el = document.getElementById('stk_'+id);
      if(el) el.classList.add('unlocked');
    });
  }

  function unlockSticker(id) {
    let earned = JSON.parse(localStorage.getItem(STICKERS_KEY) || "[]");
    if(!earned.includes(id)) {
      earned.push(id);
      localStorage.setItem(STICKERS_KEY, JSON.stringify(earned));
    }
  }

  // =========================
  // INIT
  // =========================
  (function init(){
    setLang("uz");
    renderLearn();
    updateProgress();
    updateBubbleScoreLine();
    updateEchoProgress();
  })();
</script>

</body>
</html>
